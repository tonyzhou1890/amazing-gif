!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).AMZGif=i()}(this,function(){"use strict";function n(t,a,h,o){return new(h=h||Promise)(function(e,i){function n(t){try{s(o.next(t))}catch(t){i(t)}}function r(t){try{s(o.throw(t))}catch(t){i(t)}}function s(t){var i;t.done?e(t.value):((i=t.value)instanceof h?i:new h(function(t){t(i)})).then(n,r)}s((o=o.apply(t,a||[])).next())})}function o(t){return"function"==typeof t}const l={notReady:"数据未就绪",wrongParam:"参数错误",noGifUrl:"未指定 gif 图片地址",gifEmpty:"gif 不存在",gifDataTypeError:"gif 数据类型错误",notGif:"文件非 gif",noConfigEl:"未指定 img 元素",noImg:"未找到 img 元素",notImg:t=>`元素 ${t} 不是图片`,isRendering:"isRendering",skinError:"皮肤出错",skinContainerIsSmall:"空间不足以显示皮肤"};function m(t,i,e){return t>>i&(1<<e)-1}const g={decode:(t,i)=>{function e(){return new Array(2**t+2).fill(0).map((t,i)=>String.fromCharCode(i))}let n=e();var r=2**t,s=2**t+1;let a=t+1,h="",o=!0;var l=i.length;let g=0,c=0,d=a,f=0,u="",p=0;for(;g<l;){for(d=a,f=0;0!==d;)8-c>=d?(f+=m(i[g],c,d)<<a-d,c+=d,d=0):(f+=m(i[g],c,8-c)<<a-d,d-=8-c,c=8),8===c&&(g++,c=0);if(f===s)break;f===r?(n=e(),a=t+1,o=!0):(void 0!==n[f]?o?(h+=n[f],p=f,o=!1):(h+=n[f],u=n[f][0],n.push(n[p]+u),p=f):(u=n[p][0],h+=n[p]+u,n.push(n[p]+u),p=f),n.length>=2**a&&a<12&&a++)}let y=new Uint8Array(h.length);for(let t=0;t<h.length;t++)y[t]=h.charCodeAt(t);return y}};function e(t,i){if(!(t instanceof ArrayBuffer)){if(o(i))return i(l.gifDataTypeError);throw new Error(l.gifDataTypeError)}var e=new Uint8Array(t);const n={ptr:0},r={header:{type:"",isGif:!1,version:"",width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0,gctList:[]},frames:[]};for(;n.ptr<e.length;){if(0===n.ptr){var s=function(i,t){const e={type:"",isGif:!1,version:""};for(let t=0;t<3;t++)e.type+=String.fromCharCode(i[t]);if(e.isGif=e.type==="GIF",e.isGif){for(let t=3;t<6;t++)e.version+=String.fromCharCode(i[t]);t.ptr=5}return e}(e,n);if(!s.isGif)return i(l.notGif);Object.assign(r.header,s)}else if(6===n.ptr){var s=function(t,i){const e={width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0};e.width=t[6]+(t[7]<<8),e.height=t[8]+(t[9]<<8),e.gctFlag=Boolean(t[10]>>7),e.cr=112&t[10],e.sortFlag=Boolean(8&t[10]),e.gctSize=Math.pow(2,1+(7&t[10])),e.gctFlag&&(e.gctStartByte=13,e.gctEndByte=13+3*e.gctSize-1);return e.bgIndex=t[11],e.pixelAspect=t[12],i.ptr=12,e}(e,n),a=(Object.assign(r.header,s),s.gctFlag?(++n.ptr,function(i,t,e){const n=3*t,r=13+n,s=[];for(let t=13;t<r;t+=3)s.push([i[t],i[t+1],i[t+2]]);return e.ptr=r-1,s}(e,s.gctSize,n)):[]);r.header.gctList=a}else if(n.ptr+1<e.length&&33===e[n.ptr]&&255===e[n.ptr+1]&&!r.appExt){a=function(i,t){const e={appName:"",repetitionTimes:0,startByte:0,endByte:0};e.startByte=t.ptr;let n=e.startByte;var r=i[n+=2];n++;for(let t=0;t<r-3;t++)e.appName+=String.fromCharCode(i[n+t]);n+=r;var s=i[n];return e.endByte=n+s,e.repetitionTimes=i[n+=2],t.ptr=e.endByte,e}(e,n);r.appExt=a}else if(n.ptr+1<e.length&&33===e[n.ptr]&&249===e[n.ptr+1])r.frames.push(c(e,n));else if(44===e[n.ptr]){let t=c(e,n);var h=r.frames[r.frames.length-1];h.endByte?r.frames.push(t):(t.startByte=h.startByte,t.disposalMethod=h.disposalMethod,t.userInputFlag=h.userInputFlag,t.transColorFlag=h.transColorFlag,t.delay=h.delay,t.transColorIdx=h.transColorIdx,r.frames[r.frames.length-1]=t)}else if(n.ptr+1<e.length&&33===e[n.ptr]&&1===e[n.ptr+1])r.frames.push(c(e,n));else if(59===e[n.ptr])break;n.ptr++}return console.log(r),r}function c(n,t){const r={startByte:t.ptr,endByte:0,width:0,height:0,left:0,top:0,disposalMethod:0,userInputFlag:!1,transColorFlag:!1,delay:0,transColorIdx:0,lctFlag:!1,interlace:!1,sortFlag:!1,lctSize:0,lctStartByte:0,lctEndByte:0,lctList:[],imageData:new Uint8Array,imageStartByte:0,imageEndByte:0};if(33===n[t.ptr]&&249===n[t.ptr+1]&&(t.ptr+=2,s=n[t.ptr],s=t.ptr+s+1,t.ptr++,r.disposalMethod=(28&n[t.ptr])>>2,r.userInputFlag=Boolean((2&n[t.ptr])>>1),r.transColorFlag=Boolean(1&n[t.ptr]),r.delay=10*(n[++t.ptr]+(n[++t.ptr]<<8)),r.transColorIdx=n[++t.ptr],(0!==n[++t.ptr]||t.ptr>s)&&(t.ptr=s)),44===n[t.ptr]){if(r.left=n[++t.ptr]+(n[++t.ptr]<<8),r.top=n[++t.ptr]+(n[++t.ptr]<<8),r.width=n[++t.ptr]+(n[++t.ptr]<<8),r.height=n[++t.ptr]+(n[++t.ptr]<<8),r.lctFlag=Boolean(128&n[++t.ptr]),r.interlace=Boolean(64&n[t.ptr]),r.sortFlag=Boolean(32&n[t.ptr]),r.lctSize=Math.pow(2,1+(7&n[t.ptr])),r.lctFlag){r.lctStartByte=t.ptr+1,r.lctEndByte=t.ptr+3*r.lctSize;for(let t=r.lctStartByte;t<r.lctEndByte;t+=3)r.lctList.push([n[t],n[t+1],n[t+2]]);t.ptr=r.lctEndByte}t.ptr++,r.imageStartByte=t.ptr;var s=n[t.ptr++];const o=[];let i=0;for(;0!==n[t.ptr]&&void 0!==n[t.ptr];){var a=n[t.ptr++],h=n.slice(t.ptr,t.ptr+a);i+=h.length,o.push(h),t.ptr+=a}r.imageEndByte=t.ptr,r.endByte=t.ptr;let e=new Uint8Array(i);for(let t=o.length-1;0<=t;t--)e.set(o[t],i-=o[t].length);r.imageData=g.decode(s,e)}return r}function i(e){var t=performance.now();let n=0,r=t;n=window.requestAnimationFrame(function t(i){1e3/60<=i-r&&(r=i-(i-r)%(1e3/60),e.map(t=>{t(i)})),n=window.requestAnimationFrame(t)})}function s(e,n,r){if(n.canvasImageData instanceof ImageData)return n.canvasImageData;var s=n.lctFlag?n.lctList:e.header.gctList,t=e.header.gctFlag?[...e.header.gctList[e.header.bgIndex],255]:null,a=e.header.width,e=e.header.height;if(!r){const u=new Uint8ClampedArray(a*e*4);var h=t||[0,0,0,255];for(let t=0,i=a*e;t<i;t+=4)u[t]=h[0],u[t+1]=h[1],u[t+2]=h[2],u[t+2]=h[3];r=new ImageData(u,a,e)}const o=new Uint8Array(n.imageData.length);if(n.interlace){let i=0,e=0;function l(){for(let t=0;t<n.width;t++)o[e]=n.imageData[i*n.width+t],e++}for(;i<n.height;)l(),i+=8;for(i=4;i<n.height;)l(),i+=8;for(i=2;i<n.height;)l(),i+=4;for(i=1;i<n.height;)l(),i+=2}else o.set(n.imageData);const g=new Uint8ClampedArray(a*e*4);for(let t=0,i=a*e;t<i;t++){var c=t%a,d=t/a>>0,f=4*t;!(c>=n.left&&c<n.left+n.width&&d>=n.top&&d<n.top+n.height)||(c=c-n.left+(d-n.top)*n.width,n.transColorFlag&&o[c]===n.transColorIdx)?(g[f]=r.data[f],g[1+f]=r.data[1+f],g[2+f]=r.data[2+f],g[3+f]=r.data[3+f]):(d=s[o[c]],g[f]=d[0],g[1+f]=d[1],g[2+f]=d[2],g[3+f]=255)}t=new ImageData(g,a,e);return n.canvasImageData=t}function r(t,i,e,n){var r=e.frames[n],n=function t(i,e){if(!(e<=0)){var n=i.frames[e-1];if(0!==n.disposalMethod&&2!==n.disposalMethod)return[1].includes(n.disposalMethod)?n.canvasImageData||s(i,n,t(i,e-1)):3===n.disposalMethod?t(i,e-1):void 0}}(e,n),e=s(e,r,n);i.putImageData(e,0,0),t.drawImage(i.canvas,0,0,e.width,e.height,0,0,t.canvas.width,t.canvas.height)}class a extends class{constructor(t){this.keys=[],this.watch={},this.amzGif=t,this.cache={},this.init()}init(){this.dirtyChecking()}dirtyChecking(){const i=[];let e;Object.keys(this.watch).map(t=>{e=this.getValue(t),this.cache[t]!==e&&i.push({key:t,oldValue:this.cache[t],newValue:e})}),i.map(t=>n(this,void 0,void 0,function*(){o(this.watch[t.key])&&(yield this.watch[t.key](t.newValue,t.oldValue))}))}getValue(t){var i=t.split(".").filter(t=>t);let e=this.amzGif;for(let t=0;t<i.length&&void 0!==(e=null===e||void 0===e?void 0:e[i[t]]);t++);return e}}{constructor(t){super(t),this.playDiv=null,this.playImg=null,this.loadingDiv=null,this.loadingImg=null,this.loadingImgRoate=0,this.handlePlay=this.handlePlay.bind(this),this.dirtyChecking=this.dirtyChecking.bind(this),this.init(),this.setWatch()}init(){const t=this.amzGif._canvas.parentElement;if(t){var i=t.getBoundingClientRect();const e=this.genMask(i.width,i.height),n=(e.style.zIndex="1",e.style.display="none",e.style.cursor="pointer",e.addEventListener("click",this.handlePlay.bind(this)),this.playDiv=e,document.createElement("img")),r=(n.src="data:image/svg+xml;base64,PHN2ZyB0PSIxNjYyNzg5NjY0NjUyIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIzNjciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNMTI4IDEzOC42NjY2NjdjMC00Ny4yMzIgMzMuMzIyNjY3LTY2LjY2NjY2NyA3NC4xNzYtNDMuNTYyNjY3bDY2My4xNDY2NjcgMzc0Ljk1NDY2N2M0MC45NiAyMy4xNjggNDAuODUzMzMzIDYwLjggMCA4My44ODI2NjZMMjAyLjE3NiA5MjguODk2QzE2MS4yMTYgOTUyLjA2NCAxMjggOTMyLjU2NTMzMyAxMjggODg1LjMzMzMzM3YtNzQ2LjY2NjY2NnoiIGZpbGw9IiMzRDNEM0QiIHAtaWQ9IjIzNjgiPjwvcGF0aD48L3N2Zz4=",n.style.width="60px",n.style.height="60px",n.style.opacity="0.6",this.playImg=n,e.appendChild(n),t.appendChild(e),this.genMask(i.width,i.height)),s=((this.loadingDiv=r).style.zIndex="2",r.style.display="none",document.createElement("img"));(this.loadingImg=s).src="data:image/svg+xml;base64,PHN2ZyB0PSIxNjYyNzg5NzI0Njc4IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM0NDEiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNNTEyLjUxMSAyMS40ODNjLTI3MS4xNjMgMC00OTEuMDI4IDIxOS44Ni00OTEuMDI4IDQ5MS4wMjggMCAyNzEuMTczIDIxOS44NTYgNDkxLjAzIDQ5MS4wMjggNDkxLjAzIDI2LjU1NCAwIDQ4LjA4LTIxLjUyNyA0OC4wOC00OC4wOCAwLTI2LjU1NC0yMS41MjYtNDguMDgtNDguMDgtNDguMDgtMjE4LjA2NSAwLTM5NC44NjktMTc2LjgwNC0zOTQuODY5LTM5NC44NyAwLTIxOC4wNiAxNzYuODEzLTM5NC44NjkgMzk0Ljg3LTM5NC44NjkgMjE4LjA2NSAwIDM5NC44NjkgMTc2LjgwNCAzOTQuODY5IDM5NC44NyAwIDI2LjU1MyAyMS41MjYgNDguMDggNDguMDggNDguMDggMjYuNTUzIDAgNDguMDgtMjEuNTI3IDQ4LjA4LTQ4LjA4IDAtMjcxLjE3My0yMTkuODU3LTQ5MS4wMy00OTEuMDMtNDkxLjAzeiIgcC1pZD0iMzQ0MiI+PC9wYXRoPjwvc3ZnPg==",s.style.width="60px",s.style.height="60px",s.style.opacity="0.6",r.appendChild(s),t.appendChild(r),this.amzGif._rAFCallbackQueue.push(this.dirtyChecking.bind(this))}else this.amzGif._errCall(l.skinError,"onError")}genMask(t,i){const e=document.createElement("div");return e.style.backgroundColor="rgba(0, 0, 0, 0.3)",e.style.width=t+"px",e.style.height=i+"px",e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e}setWatch(){this.watch.isPlaying=t=>{this.playDiv&&(this.playDiv.style.display=t||this.amzGif.isLoading?"none":"flex")},this.watch.isLoading=t=>{this.loadingDiv&&(this.loadingDiv.style.display=t?"flex":"none",t&&this.loadingImg&&(this.loadingImg.style.transform=`rotate(${this.loadingImgRoate+=1}deg)`))}}handlePlay(){this.amzGif.isPlaying||this.amzGif.play()}}const h={loop:!0,auto:!1,interface:!0,skin:"basic",speed:1},d=[.5,1,1.5,2];return class{constructor(t){this.speedList=d,this._imgEl=null,this._canvas=null,this._ctx=null,this._offscreenCanvas=null,this._offscreenCtx=null,this._gifBuffer=null,this.gifData=null,this._currFrame=-1,this._nextUpdateTime=performance.now(),this._rAFCallbackQueue=[],this.isLoading=!1,this.isPlaying=!1,this.isRendering=!1,this._config=Object.assign(Object.assign({},h),t),d.includes(this._config.speed)||(this._config.speed=1),this._update=this._update.bind(this),this._renderFrame=this._renderFrame.bind(this),this._togglePlay=this._togglePlay.bind(this),this._init()}_init(){if(this._config.el){if(this._config.el instanceof HTMLImageElement&&(this._imgEl=this._config.el),"string"==typeof this._config.el){var t=document.querySelector(this._config.el);if(!t)return void this._errCall(l.noImg+this._config.el,"onError");if(!(t instanceof HTMLImageElement))return void this._errCall(l.notImg(this._config.el),"onError");this._imgEl=t}null!=(t=this._imgEl)&&t.addEventListener("load",()=>{var t;this._initCanvas(),this._initContainer(),(t=this)._config.interactive&&"basic"===t._config.skin&&new a(t),!0===this._config.auto&&this.play(),this._rAFCallbackQueue.push(this._update),i(this._rAFCallbackQueue)})}else this._errCall(l.noConfigEl,"onError")}_initCanvas(){var t;const i=this._imgEl;var e=i.getBoundingClientRect();console.log(e),this._config.width="number"==typeof this._config.width?this._config.width:null!=(t=null==e?void 0:e.width)?t:0,this._config.height="number"==typeof this._config.height?this._config.height:null!=(t=null==e?void 0:e.height)?t:0,this._canvas=document.createElement("canvas"),this._canvas.style.cursor="pointer",this._canvas.addEventListener("click",this._togglePlay),this._canvas.width=this._config.width,this._canvas.height=this._config.height,this._canvas.style.width=this._config.width+"px",this._canvas.style.height=this._config.height+"px",this._ctx=this._canvas.getContext("2d"),this._ctx.globalCompositeOperation="copy",null!=(t=this._ctx)&&t.drawImage(i,0,0,null!=(t=null==e?void 0:e.width)?t:this._config.width,null!=(t=null==e?void 0:e.height)?t:this._config.height,0,0,null!=(t=this._config.width)?t:null==e?void 0:e.width,null!=(t=this._config.height)?t:null==e?void 0:e.height)}_initContainer(){var t,i=this._imgEl;const e=document.createElement("div");i.id&&(e.id=i.id),e.style.width=this._config.width+"px",e.style.height=this._config.height+"px",e.style.position="relative",e.style.display="inline-block",this._canvas&&(e.appendChild(this._canvas),null!=(t=i.parentElement)&&t.replaceChild(e,i))}play(){var i;return n(this,void 0,void 0,function*(){if(null===this._gifBuffer){if(!this._config.src)return this._errCall(l.noGifUrl,"onError");yield this._getGif().catch(t=>this._errCall(t.message,"onLoadError"))}if(null===this._gifBuffer)this._errCall(l.gifEmpty,"onDataError");else{if(null===this.gifData){var t=e(this._gifBuffer,this._errCall);if(!t||!t.header.isGif)return;this.gifData=t,this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=null==(i=this.gifData)?void 0:i.header.width,this._offscreenCanvas.height=null==(i=this.gifData)?void 0:i.header.height,this._offscreenCtx=this._offscreenCanvas.getContext("2d")}if(o(this._config.onBeforePlay))if(!(yield this._config.onBeforePlay()))return;this.isPlaying=!0,this._nextUpdateTime=Math.max(this._nextUpdateTime,performance.now()),this._checkEnd()&&(this._currFrame=-1),o(this._config.onPlay)&&this._config.onPlay()}})}pause(){return n(this,void 0,void 0,function*(){if(o(this._config.onBeforePause)&&!(yield this._config.onBeforePause()))return;this.isPlaying=!1,o(this._config.onPause)&&this._config.onPause()})}nextFrame(){return this.gifData&&this._ctx&&this._offscreenCtx?this.isRendering?l.isRendering:(this._currFrame=(this._currFrame+1)%this.gifData.frames.length,this._renderFrame(),void(this._nextUpdateTime=performance.now()+this.gifData.frames[this._currFrame].delay/this._config.speed)):this._errCall(l.notReady,"onError")}prevFrame(){return this.gifData&&this._ctx&&this._offscreenCtx?this.isRendering?l.isRendering:(this._currFrame--,this._currFrame<0&&(this._currFrame=this.gifData.frames.length-1),this._renderFrame(),void(this._nextUpdateTime=performance.now()+this.gifData.frames[this._currFrame].delay/this._config.speed)):this._errCall(l.notReady,"onError")}jump(t){return n(this,void 0,void 0,function*(){return this.gifData?"number"!=typeof t?this._errCall(l.wrongParam,"onError"):this.isRendering?l.isRendering:((t<0||t>this.gifData.frames.length-1)&&(t=0),this._currFrame=t,void this._renderFrame()):this._errCall(l.notReady,"onError")})}setSpeed(t){return!!this.speedList.includes(t)&&(this._config.speed=t,!0)}_togglePlay(){!1!==this._config.interactive&&(this.isPlaying?this.pause():this.play())}_update(t){if(this.isPlaying&&!this.isRendering&&this.gifData&&this._ctx&&this._offscreenCtx&&!document.hidden&&!(this._nextUpdateTime>t))if(this._currFrame++,this._checkEnd())this.isPlaying=!1,o(this._config.onEnd)&&this._config.onEnd();else for(this._renderFrame();this._nextUpdateTime<=t;)this._nextUpdateTime+=Math.max(this.gifData.frames[this._currFrame].delay/this._config.speed,1),this._nextUpdateTime<=t&&(this._currFrame++,this._checkEnd()&&(this.isPlaying=!1,o(this._config.onEnd)&&this._config.onEnd(),this._currFrame=this.gifData.frames.length-1,this._renderFrame()))}_renderFrame(){var t=this.gifData,i=this._ctx,e=this._offscreenCtx;this.isRendering=!0,r(i,e,t,this._currFrame),this.isRendering=!1}_checkEnd(){return this._currFrame>this.gifData.frames.length-1&&(!1===this._config.loop||(this._currFrame=0,!1))}_getGif(){return n(this,void 0,void 0,function*(){if(this.isLoading=!0,o(this._config.httpRequest))try{const t=yield this._config.httpRequest(this._config.src);this._gifBuffer=yield t.arrayBuffer()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}else try{const i=yield fetch(this._config.src);this._gifBuffer=yield i.arrayBuffer()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}this.isLoading=!1})}_errCall(t,i){var e;if(o(this._config[i]))null!=(i=(e=this._config)[i])&&i.call(e,t);else{if(!o(this._config.onError))throw new Error(t);null!=(e=(i=this._config).onError)&&e.call(i,t)}}}});
