!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).AMZGif={})}(this,(function(t){"use strict";function e(t,e,i,a){return new(i||(i=Promise))((function(n,s){function r(t){try{l(a.next(t))}catch(t){s(t)}}function o(t){try{l(a.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,o)}l((a=a.apply(t,e||[])).next())}))}function i(t){return"function"==typeof t}const a="数据未就绪",n="参数错误",s="未指定 gif 图片地址",r="gif 数据类型错误",o="文件非 gif",l="未指定 img 元素",d="未找到 img 元素",h=t=>`元素 ${t} 不是图片`,c="isRendering",u="皮肤出错";function g(t){let e=1;for(;t>2**e;)e++;return e}function f(t,e,i,a){return((1<<i)-1&a)<<e|t}var p=null;try{var m="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");p=m.Worker}catch(t){}function b(t,e,i){var a=void 0===e?null:e,n=function(t,e){return Buffer.from(t,"base64").toString(e?"utf16":"utf8")}(t,void 0!==i&&i),s=n.indexOf("\n",10)+1,r=n.substring(s)+(a?"//# sourceMappingURL="+a:"");return function(t){return new p(r,Object.assign({},t,{eval:!0}))}}function y(t,e,i){var a=void 0===e?null:e,n=function(t,e){var i=atob(t);if(e){for(var a=new Uint8Array(i.length),n=0,s=i.length;n<s;++n)a[n]=i.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(a.buffer))}return i}(t,void 0!==i&&i),s=n.indexOf("\n",10)+1,r=n.substring(s)+(a?"//# sourceMappingURL="+a:""),o=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(o)}var G="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);var Z,L,x,C=(Z="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7ZnVuY3Rpb24gdCh0LGUsbyl7cmV0dXJuIHQ+PmUmKDE8PG8pLTF9ZnVuY3Rpb24gZSh0LGUsbyxuKXtyZXR1cm4oKDE8PG8pLTEmbik8PGV8dH1jb25zdCBvPXtkZWNvZGU6KGUsbyk9PntmdW5jdGlvbiBuKCl7cmV0dXJuIG5ldyBBcnJheSgyKiplKzIpLmZpbGwoMCkubWFwKCgodCxlKT0+U3RyaW5nLmZyb21DaGFyQ29kZShlKSkpfWxldCBhPW4oKTtjb25zdCBsPTIqKmUscz0yKiplKzE7bGV0IHI9ZSsxLGk9IiIsZD0hMDtjb25zdCBoPW8ubGVuZ3RoO2xldCBjPTAsZj0wLHU9cixnPTAsbT0iIix3PTA7Zm9yKDtjPGg7KXtmb3IodT1yLGc9MDswIT09dSYmKDgtZj49dT8oZys9dChvW2NdLGYsdSk8PHItdSxmKz11LHU9MCk6KGcrPXQob1tjXSxmLDgtZik8PHItdSx1LT04LWYsZj04KSwhKDg9PT1mJiYoYysrLGY9MCxjPj1oKSkpOyk7aWYoZz09PXMpYnJlYWs7ZyE9PWw/KHZvaWQgMCE9PWFbZ10/ZD8oaSs9YVtnXSx3PWcsZD0hMSk6KGkrPWFbZ10sbT1hW2ddWzBdLGEucHVzaChhW3ddK20pLHc9Zyk6KHZvaWQgMD09PWFbd10mJmNvbnNvbGUubG9nKHcsaS5sZW5ndGgpLG09YVt3XVswXSxpKz1hW3ddK20sYS5wdXNoKGFbd10rbSksdz1nKSxhLmxlbmd0aD49MioqciYmcjwxMiYmcisrKTooYT1uKCkscj1lKzEsZD0hMCl9Y29uc3QgQz1uZXcgVWludDhBcnJheShpLmxlbmd0aCk7Zm9yKGxldCB0PTA7dDxpLmxlbmd0aDt0KyspQ1t0XT1pLmNoYXJDb2RlQXQodCk7cmV0dXJuIEN9LGVuY29kZToodCxvKT0+e2Z1bmN0aW9uIG4oKXtjb25zdCBlPW5ldyBNYXA7cmV0dXJuIG5ldyBBcnJheSgyKip0KS5maWxsKDApLm1hcCgoKHQsbyk9PntlLnNldChTdHJpbmcuZnJvbUNoYXJDb2RlKG8pLG8pfSkpLGV9ZnVuY3Rpb24gYSh0KXtsZXQgbz1kO2lmKGYrMj49Yy5sZW5ndGgpe2NvbnN0IHQ9bmV3IFVpbnQ4QXJyYXkoYy5sZW5ndGgrMjU2KTt0LnNldChjKSxjPXR9Zm9yKDtvOyk4LXU+PW8/KGNbZl09ZShjW2ZdLHUsbyx0KSx1Kz1vLG89MCk6KGNbZl09ZShjW2ZdLHUsOC11LHQpLHQ+Pj04LXUsby09OC11LHU9OCksOD09PXUmJih1PTAsZisrKX1sZXQgbD1uKCk7Y29uc3Qgcz0yKip0LHI9MioqdCsxO2xldCBpPTIqKnQrMixkPXQrMSxoPTIqKmQ7bGV0IGM9bmV3IFVpbnQ4QXJyYXkoMjU2KSxmPTAsdT0wLGc9IiIsbT0iIjthKHMpO2ZvcihsZXQgZT0wLHI9by5sZW5ndGg7ZTxyO2UrKyltPVN0cmluZy5mcm9tQ2hhckNvZGUob1tlXSksbC5oYXMoZyttKT9nKz1tOihhKGwuZ2V0KGcpKSw0MDkzPT09aT8oYShzKSxsPW4oKSxpPTIqKnQrMixkPXQrMSxoPTIqKmQpOmk9PT1oPyhkKyssaD0yKipkLGwuc2V0KGcrbSxpKyspKTpsLnNldChnK20saSsrKSxnPW0sbT0iIik7ZyYmYShsLmdldChnKSksYShyKTtsZXQgdz1udWxsO3JldHVybiB3PXU/Yy5zbGljZSgwLGYrMSk6Yy5zbGljZSgwLGYpLHd9fTtjbGFzcyBue2NvbnN0cnVjdG9yKCl7dGhpcy5tYXhDb2xvcj0yNTQsdGhpcy5jb2xvckNvdW50PTAsdGhpcy50cmVlPW5ldyBhLHRoaXMudHJlZS5sZXZlbD0tMSx0aGlzLmxldmVsTm9kZXM9bmV3IEFycmF5KDgpLmZpbGwoMCkubWFwKCgoKT0+W10pKX1hZGRDb2xvcihlLG8sbil7bGV0IGw9dGhpcy50cmVlO2ZvcihsZXQgcz03O3M+PTA7cy0tKXtjb25zdCByPSh0KGUscywxKTw8MikrKHQobyxzLDEpPDwxKSt0KG4scywxKTtsZXQgaT1sLm5vZGVzW3JdO2lmKGl8fChsLm5vZGVzW3JdPW5ldyBhLGk9bC5ub2Rlc1tyXSxpLmxldmVsPTctcyxpLnBhcmVudD1sLGwubm9kZXNDb3VudCsrLGkuaWR4SW5MZXZlbE5vZGVzPXRoaXMubGV2ZWxOb2Rlc1tpLmxldmVsXS5sZW5ndGgsdGhpcy5sZXZlbE5vZGVzW2kubGV2ZWxdLnB1c2goaSksNz09PWkubGV2ZWwmJnRoaXMuY29sb3JDb3VudCsrKSxpLmNvdW50KyssaS5yZWRTdW0rPWUsaS5ncmVlblN1bSs9byxpLmJsdWVTdW0rPW4saS5pc0xlYWYpYnJlYWs7Nz09PWkubGV2ZWwmJihpLmlzTGVhZj0hMCksbD1pfXRoaXMuY29sb3JDb3VudD50aGlzLm1heENvbG9yJiZ0aGlzLnJlZHVjZUNvbG9yKCl9Z2V0Q29sb3IoZSxvLG4pe2xldCBhPXRoaXMudHJlZTtjb25zdCBsPVswLDAsMCwwXTtmb3IobGV0IHM9NztzPj0wO3MtLSl7Y29uc3Qgcj0odChlLHMsMSk8PDIpKyh0KG8scywxKTw8MSkrdChuLHMsMSksaT1hLm5vZGVzW3JdO2lmKCFpKWJyZWFrO2lmKGkuaXNMZWFmKXtsWzBdPWkucmVkU3VtL2kuY291bnQ+PjAsbFsxXT1pLmdyZWVuU3VtL2kuY291bnQ+PjAsbFsyXT1pLmJsdWVTdW0vaS5jb3VudD4+MCxsWzNdPTE7YnJlYWt9YT1pfXJldHVybiBsfXJlZHVjZUNvbG9yKCl7bGV0IHQ9bnVsbCxlPU51bWJlci5NQVhfU0FGRV9JTlRFR0VSO2ZvcihsZXQgbz02O28+PTA7by0tKXtjb25zdCBuPXRoaXMubGV2ZWxOb2Rlc1tvXTtmb3IobGV0IG89MCxhPW4ubGVuZ3RoO288YTtvKyspaWYobltvXSl7Y29uc3QgYT1uW29dOyFhLmlzTGVhZiYmYS5ub2Rlc0NvdW50PjEmJmEuY291bnQ8ZSYmKHQ9YSxlPWEuY291bnQpfWlmKHQpYnJlYWt9dCYmdGhpcy5kZWxldGVTdWJOb2Rlcyh0KX1kZWxldGVTdWJOb2Rlcyh0KXtmb3IobGV0IGU9MCxvPXQubm9kZXMubGVuZ3RoO2U8bztlKyspe2NvbnN0IG89dC5ub2Rlc1tlXTtvJiYoby5pc0xlYWZ8fHRoaXMuZGVsZXRlU3ViTm9kZXMobyksdGhpcy5sZXZlbE5vZGVzW28ubGV2ZWxdW28uaWR4SW5MZXZlbE5vZGVzXT1udWxsKX10aGlzLmNvbG9yQ291bnQtPXQubm9kZXNDb3VudC0xLHQubm9kZXM9W10sdC5ub2Rlc0NvdW50PTAsdC5pc0xlYWY9ITB9fWNsYXNzIGF7Y29uc3RydWN0b3IoKXt0aGlzLmlzTGVhZj0hMSx0aGlzLmxldmVsPTAsdGhpcy5jb3VudD0wLHRoaXMucmVkU3VtPTAsdGhpcy5ncmVlblN1bT0wLHRoaXMuYmx1ZVN1bT0wLHRoaXMucGFyZW50PW51bGwsdGhpcy5ub2Rlcz1bXSx0aGlzLm5vZGVzQ291bnQ9MCx0aGlzLmlkeEluTGV2ZWxOb2Rlcz0wfX1mdW5jdGlvbiBsKHQsZSxvKXtyZXR1cm4gNCoobyp0LndpZHRoK2UpfWZ1bmN0aW9uIHModCxlKXtyZXR1cm57eDplLzQldC53aWR0aCx5OmUvND4+MH19ZnVuY3Rpb24gcih0LGU9MCl7aWYodC5sZW5ndGg+PWUrNCYmdFtlKzNdPjAmJnRbZSszXTwyNTUpe2NvbnN0IG89dFtlKzNdLzI1NTt0W2VdPXRbZV0qbz4+MCx0W2UrMV09dFtlKzFdKm8+PjAsdFtlKzJdPXRbZSsyXSpvPj4wLHRbZSszXT0yNTV9cmV0dXJuIHR9ZnVuY3Rpb24gaSh0LGUsbyl7Y29uc3Qgbj10LmpvaW4oKTtpZihvLmhhcyhuKSlyZXR1cm4gby5nZXQobik7e2xldCBhPVtdLGw9MS8wLHM9LTE7Zm9yKGxldCBvPTAsbj1lLmxlbmd0aDtvPG47bysrKXtjb25zdCBuPWVbb10sYT0odFswXStuWzBdKS8yLHI9dFswXS1uWzBdLGk9dFsxXS1uWzFdLGQ9dFsyXS1uWzJdLGg9TWF0aC5zcXJ0KCgyK2EvMjU2KSpyKnIrNCppKmkrKDIrKDI1NS1hKS8yNTYpKmQqZCk7aWYoaDxsJiYobD1oLHM9byxsPDEpKWJyZWFrfXJldHVybiBhPVsuLi5lW3NdLDFdLG8uc2V0KG4sYSksYX19Y29uc3QgZD17Z2lmTHp3RGVjb2RlOm8uZGVjb2RlLGdpZkx6d0VuY29kZTpvLmVuY29kZSxjb2xvclRyYW5zZm9ybTpmdW5jdGlvbih0LGU9ITEpe2NvbnN0IG89e2NvbG9yVGFibGU6W10sZnJhbWVzOltdfTtpZighdC5sZW5ndGgpcmV0dXJuIG87Y29uc3QgYT1uZXcgTWFwLGQ9bmV3IE1hcCxoPW5ldyBuO2xldCBjPW51bGwsZj0tMTtmb3IobGV0IGU9MCxvPXQubGVuZ3RoO2U8bztlKyspe2NvbnN0IG89dFtlXS5pbWFnZURhdGE7Zm9yKGxldCB0PTAsZT1vLndpZHRoKm8uaGVpZ2h0KjQ7dDxlO3QrPTQpMD09PW8uZGF0YVt0KzNdP251bGw9PT1jJiYoYz1bby5kYXRhW3RdLG8uZGF0YVt0KzFdLG8uZGF0YVt0KzJdLDBdKToocihvLmRhdGEsdCksaC5hZGRDb2xvcihvLmRhdGFbdF0sby5kYXRhW3QrMV0sby5kYXRhW3QrMl0pKX1mPWguY29sb3JDb3VudDtmb3IobGV0IGU9MCxuPXQubGVuZ3RoO2U8bjtlKyspe2NvbnN0IG49bmV3IEltYWdlRGF0YSh0W2VdLmltYWdlRGF0YS53aWR0aCx0W2VdLmltYWdlRGF0YS5oZWlnaHQpO24uZGF0YS5zZXQodFtlXS5pbWFnZURhdGEuZGF0YSk7Y29uc3QgbD1uZXcgVWludDhBcnJheShuLndpZHRoKm4uaGVpZ2h0KTtmb3IobGV0IHQ9MCxlPTAscz1uLndpZHRoKm4uaGVpZ2h0KjQ7dDxzO3QrPTQsZSsrKWlmKDAhPT1uLmRhdGFbdCszXSl7bGV0IHM9bnVsbDtjb25zdCByPVtuLmRhdGFbdF0sbi5kYXRhW3QrMV0sbi5kYXRhW3QrMl1dLmpvaW4oKTthLmhhcyhyKT9zPWEuZ2V0KHIpOihzPWguZ2V0Q29sb3Iobi5kYXRhW3RdLG4uZGF0YVt0KzFdLG4uZGF0YVt0KzJdKSxhLnNldChyLHMpLGQuaGFzKHMuam9pbigpKXx8KGQuc2V0KHMuam9pbigpLG8uY29sb3JUYWJsZS5sZW5ndGgpLG8uY29sb3JUYWJsZS5wdXNoKFtzWzBdLHNbMV0sc1syXV0pKSksbi5kYXRhW3RdPXNbMF0sbi5kYXRhW3QrMV09c1sxXSxuLmRhdGFbdCsyXT1zWzJdLGxbZV09ZC5nZXQocy5qb2luKCkpfWVsc2UgbFtlXT1mO28uZnJhbWVzLnB1c2goe2ltYWdlRGF0YTpuLGluZGljZXM6bH0pfXJldHVybiBjPWN8fG8uY29sb3JUYWJsZVtvLmNvbG9yVGFibGUubGVuZ3RoLTFdLG8uY29sb3JUYWJsZS5wdXNoKFtjWzBdLGNbMV0sY1sxXV0pLGUmJmZ1bmN0aW9uKHQsZSxvKXtjb25zdCBuPVtbMSwwLDcvMTZdLFstMSwxLDMvMTZdLFswLDEsNS8xNl0sWzEsMSwxLzE2XV0sYT1uZXcgTWFwO2ZvcihsZXQgcj0wLGQ9dC5sZW5ndGg7cjxkO3IrKyl7Y29uc3QgZD10W3JdLmltYWdlRGF0YSxoPWUuZnJhbWVzW3JdLmltYWdlRGF0YTtuZXcgSW1hZ2VEYXRhKGgud2lkdGgsaC5oZWlnaHQpLmRhdGEuc2V0KGguZGF0YSk7Y29uc3QgYz1lLmZyYW1lc1tyXS5pbmRpY2VzO2ZvcihsZXQgdD0wLHI9ZC53aWR0aCpkLmhlaWdodCo0O3Q8cjt0Kz00KXtpZigwPT09aC5kYXRhW3QrM10pY29udGludWU7Y29uc3Qgcj1zKGQsdCk7Zm9yKGxldCBlPTA7ZTw0O2UrKyl7Y29uc3Qgbz1uW2VdLGE9e3g6ci54K29bMF0seTpyLnkrb1sxXX07aWYoYS54Pj0wJiZhLng8ZC53aWR0aCYmYS55Pj0wJiZhLnk8ZC5oZWlnaHQpe2NvbnN0IGU9bChkLGEueCxhLnkpO2lmKDA9PT1oLmRhdGFbZSszXSljb250aW51ZTtmb3IobGV0IG49MDtuPDM7bisrKXtjb25zdCBhPWQuZGF0YVt0K25dLWguZGF0YVt0K25dO2guZGF0YVtlK25dKz1hKm9bMl19fX1jb25zdCBmPWkoW2guZGF0YVt0XSxoLmRhdGFbdCsxXSxoLmRhdGFbdCsyXV0sZS5jb2xvclRhYmxlLGEpO2guZGF0YVt0XT1mWzBdLGguZGF0YVt0KzFdPWZbMV0saC5kYXRhW3QrMl09ZlsyXSxjW3QvND4+MF09by5nZXQoZi5qb2luKCkpfW5ldyBJbWFnZURhdGEoaC53aWR0aCxoLmhlaWdodCkuZGF0YS5zZXQoaC5kYXRhKX19KHQsbyxkKSxvfSxyZXBsYWNlUmVwZWF0ZWRJbmRpY2VzOmZ1bmN0aW9uKHQpe2lmKHQuZnJhbWVzLnNvbWUoKHQ9PnQubGN0RmxhZykpKXJldHVybiB0O2NvbnN0IGU9dC5oZWFkZXIuYmdJbmRleCxvPXQuaGVhZGVyLndpZHRoLG49dC5oZWFkZXIuaGVpZ2h0O2xldCBhPW5ldyBVaW50OEFycmF5KG8qbikuZmlsbChlKTtmb3IobGV0IG49MCxsPXQuZnJhbWVzLmxlbmd0aDtuPGw7bisrKXtjb25zdCBsPXQuZnJhbWVzW25dLHM9bmV3IFVpbnQ4QXJyYXkoYSk7Zm9yKGxldCB0PTAsbj1zLmxlbmd0aDt0PG47dCsrKXtjb25zdCBuPXQlbyxhPXQvbz4+MDtpZihuPj1sLmxlZnQmJm48bC5sZWZ0K2wud2lkdGgmJmE+PWwudG9wJiZhPGwudG9wK2wuaGVpZ2h0KXtjb25zdCBvPShhLWwudG9wKSpsLndpZHRoKyhuLWwubGVmdCk7bC50cmFuc0NvbG9yRmxhZyYmbC5pbWFnZURhdGFbb10hPT1sLnRyYW5zQ29sb3JJZHgmJmwuaW1hZ2VEYXRhW29dIT09ZSYmbC5pbWFnZURhdGFbb109PT1zW3RdJiYobC5pbWFnZURhdGFbb109bC50cmFuc0NvbG9ySWR4KSxzW3RdPWwuaW1hZ2VEYXRhW29dfX1pZihbMCwxXS5pbmNsdWRlcyhsLmRpc3Bvc2FsTWV0aG9kKSlhPXM7ZWxzZSBpZigyPT09bC5kaXNwb3NhbE1ldGhvZCl7Zm9yKGxldCB0PTA7dDxsLmhlaWdodDt0KyspZm9yKGxldCBuPTA7bjxsLndpZHRoO24rKyl7c1sodCtsLnRvcCkqbytuK2wubGVmdF09ZX1hPXN9fXJldHVybiB0fX07b25tZXNzYWdlPXQ9Pntjb25zdHthY3Rpb246ZSxwYXJhbTpvLF9zaWduOm59PXQuZGF0YTtpZigiZnVuY3Rpb24iPT10eXBlb2YgZFtlXSl7Y29uc3QgdD17YWN0aW9uOmUscmVzdWx0OmRbZV0oLi4ubnVsbCE9bz9vOltdKSxfc2lnbjpufTtwb3N0TWVzc2FnZSh0KX1lbHNlIGNvbnNvbGUubG9nKGBhY3Rpb24gJHtlfSBub3QgZm91bmRgKX19KCk7Ci8vIyBzb3VyY2VNYXBwaW5nVVJMPXdvcmtlclV0aWxzLmpzLm1hcAoK",L=null,x=!1,G?b(Z,L,x):function(t,e,i){var a;return function(n){return a=a||y(t,e,i),new Worker(a,n)}}(Z,L,x));const M=Math.max(window.navigator.hardwareConcurrency-1,1),v=new Map,W=[],w=new Array(M).fill(null).map(((t,e)=>({index:e,worker:new C,idle:!0})));function I(){let t=null,e=null;W.length&&(t=w.find((t=>t.idle)),t&&(t.idle=!1,e=W.shift(),v.set(e._sign,e.p),t.worker.postMessage(Object.assign(Object.assign({},e.job),{_sign:e._sign}),e.job.transferable||[])))}w.map((t=>{t.worker.addEventListener("message",(e=>{e.data&&e.data._sign?(v.get(e.data._sign).resolve(e.data.result),v.delete(e.data._sign),t.idle=!0,I()):(console.error("worker 返回数据错误"),v.get(e.data._sign).reject("worker 返回数据错误"))}))}));var _=t=>new Promise(((e,i)=>{const a=Date.now()*Math.random();W.push({_sign:a,job:t,p:{resolve:e,reject:i}}),I()}));function K(t,a){return e(this,void 0,void 0,(function*(){if(!(t instanceof ArrayBuffer)){if(i(a))return a(r,"onDataError");throw new Error(r)}const e=new Uint8Array(t),n={ptr:0},s={header:{type:"",isGif:!1,version:"",width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0,gctList:[]},frames:[]};for(console.time("parse");n.ptr<e.length;){if(0===n.ptr){const t=z(e,n);if(!t.isGif){if(i(a))return a(o,"onDataError");throw new Error(o)}Object.assign(s.header,t)}else if(6===n.ptr){const t=X(e,n);Object.assign(s.header,t);const i=t.gctFlag?(++n.ptr,D(e,t.gctSize,n)):[];s.header.gctList=i}else if(n.ptr+1<e.length&&33===e[n.ptr]&&255===e[n.ptr+1]&&!s.appExt){const t=F(e,n);s.appExt=t}else if(n.ptr+1<e.length&&33===e[n.ptr]&&249===e[n.ptr+1])s.frames.push(Y(e,n));else if(44===e[n.ptr]){const t=Y(e,n),i=s.frames[s.frames.length-1];i&&!i.endByte?(t.gceFlag=i.gceFlag,t.startByte=i.startByte,t.disposalMethod=i.disposalMethod,t.userInputFlag=i.userInputFlag,t.transColorFlag=i.transColorFlag,t.delay=i.delay,t.transColorIdx=i.transColorIdx,s.frames[s.frames.length-1]=t):s.frames.push(t)}else if(n.ptr+1<e.length&&33===e[n.ptr]&&1===e[n.ptr+1])s.frames.push(Y(e,n));else if(59===e[n.ptr])break;n.ptr++}const l=yield Promise.all(s.frames.map((t=>_({action:"gifLzwDecode",param:[t.codeSize,t.imageData],transferable:[t.imageData.buffer]}))));return console.timeEnd("parse"),l.map(((t,e)=>{s.frames[e].imageData=t})),s}))}function z(t,e){const i={type:"",isGif:!1,version:""};for(let e=0;e<3;e++)i.type+=String.fromCharCode(t[e]);if(i.isGif="GIF"===i.type,!i.isGif)return i;for(let e=3;e<6;e++)i.version+=String.fromCharCode(t[e]);return e.ptr=5,i}function X(t,e){const i={width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0};return i.width=t[6]+(t[7]<<8),i.height=t[8]+(t[9]<<8),i.gctFlag=Boolean(t[10]>>7),i.cr=t[10]>>4&7,i.sortFlag=Boolean(8&t[10]),i.gctSize=Math.pow(2,1+(7&t[10])),i.gctFlag&&(i.gctStartByte=13,i.gctEndByte=13+3*i.gctSize-1),i.bgIndex=t[11],i.pixelAspect=t[12],e.ptr=12,i}function D(t,e,i){const a=3*e+13,n=[];for(let e=13;e<a;e+=3)n.push([t[e],t[e+1],t[e+2]]);return i.ptr=a-1,n}function F(t,e){const i={appName:"",verification:"",blockIdx:1,repetitionTimes:0,startByte:0,endByte:0};i.startByte=e.ptr;let a=i.startByte;const n=t[a+=2];a++;for(let e=0;e<n-3;e++)i.appName+=String.fromCharCode(t[a+e]);a+=n-3;for(let e=0;e<3;e++)i.verification+=String.fromCharCode(t[a+e]);a+=3;const s=t[a];return i.endByte=a+s,i.blockIdx=t[a+1],i.repetitionTimes=t[a+2]+(t[a+3]<<8),e.ptr=i.endByte,i}function Y(t,e){const i={gceFlag:!1,startByte:e.ptr,endByte:0,width:0,height:0,left:0,top:0,disposalMethod:0,userInputFlag:!1,transColorFlag:!1,delay:0,transColorIdx:0,lctFlag:!1,interlace:!1,sortFlag:!1,lctSize:0,lctStartByte:0,lctEndByte:0,lctList:[],codeSize:0,imageData:new Uint8Array,imageStartByte:0,imageEndByte:0};if(33===t[e.ptr]&&249===t[e.ptr+1]){i.gceFlag=!0,e.ptr+=2;const a=t[e.ptr],n=e.ptr+a+1;e.ptr++,i.disposalMethod=(28&t[e.ptr])>>2,i.userInputFlag=Boolean((2&t[e.ptr])>>1),i.transColorFlag=Boolean(1&t[e.ptr]),i.delay=10*(t[++e.ptr]+(t[++e.ptr]<<8)),i.transColorIdx=t[++e.ptr],(0!==t[++e.ptr]||e.ptr>n)&&(e.ptr=n)}if(44===t[e.ptr]){if(i.left=t[++e.ptr]+(t[++e.ptr]<<8),i.top=t[++e.ptr]+(t[++e.ptr]<<8),i.width=t[++e.ptr]+(t[++e.ptr]<<8),i.height=t[++e.ptr]+(t[++e.ptr]<<8),i.lctFlag=Boolean(128&t[++e.ptr]),i.interlace=Boolean(64&t[e.ptr]),i.sortFlag=Boolean(32&t[e.ptr]),i.lctSize=Math.pow(2,1+(7&t[e.ptr])),i.lctFlag){i.lctStartByte=e.ptr+1,i.lctEndByte=e.ptr+3*i.lctSize;for(let e=i.lctStartByte;e<i.lctEndByte;e+=3)i.lctList.push([t[e],t[e+1],t[e+2]]);e.ptr=i.lctEndByte}e.ptr++,i.imageStartByte=e.ptr;const a=t[e.ptr++],n=[];let s=0;for(;0!==t[e.ptr]&&void 0!==t[e.ptr];){const i=t[e.ptr++],a=t.slice(e.ptr,e.ptr+i);s+=a.length,n.push(a),e.ptr+=i}i.imageEndByte=e.ptr,i.endByte=e.ptr;const r=new Uint8Array(s);for(let t=n.length-1;t>=0;t--)r.set(n[t],s-=n[t].length);i.codeSize=a,i.imageData=r}return i}function V(t){return e(this,void 0,void 0,(function*(){const i={buf:P(new Uint8Array(0)),ptr:0};return function(t,e){t.buf[0]=e.type.charCodeAt(0),t.buf[1]=e.type.charCodeAt(1),t.buf[2]=e.type.charCodeAt(2),t.buf[3]=e.version.charCodeAt(0),t.buf[4]=e.version.charCodeAt(1),t.buf[5]=e.version.charCodeAt(2),t.ptr=6}(i,t.header),function(t,e){t.buf[6]=255&e.width,t.buf[7]=e.width>>8,t.buf[8]=255&e.height,t.buf[9]=e.height>>8,t.buf[10]=f(t.buf[10],7,1,Number(e.gctFlag)),t.buf[10]=f(t.buf[10],4,3,e.cr-1),t.buf[10]=f(t.buf[10],3,1,Number(e.sortFlag)),t.buf[10]=f(t.buf[10],0,3,g(e.gctSize)-1),t.buf[11]=e.bgIndex,t.buf[12]=e.pixelAspect,t.ptr=13}(i,t.header),t.header.gctFlag&&N(i,t.header.gctList),t.appExt&&function(t,e){t.ptr+18>=t.buf.length&&(t.buf=P(t.buf));t.buf[t.ptr++]=33,t.buf[t.ptr++]=255,t.buf[t.ptr++]=e.appName.length+e.verification.length;for(let i=0,a=e.appName.length;i<a;i++)t.buf[t.ptr++]=e.appName.charCodeAt(i);for(let i=0,a=e.verification.length;i<a;i++)t.buf[t.ptr++]=e.verification.charCodeAt(i);t.buf[t.ptr++]=3,t.buf[t.ptr++]=e.blockIdx,t.buf[t.ptr++]=255&e.repetitionTimes,t.buf[t.ptr++]=e.repetitionTimes>>8,t.buf[t.ptr++]=0}(i,t.appExt),yield function(t,i,a){return e(this,void 0,void 0,(function*(){const e=[],n=window.performance.now(),s=yield Promise.all(i.map(((t,i)=>(e[i]=t.lctFlag?g(t.lctSize):g(a),_({action:"gifLzwEncode",param:[e[i],t.imageData]})))));console.log("encode frames buffer: ",window.performance.now()-n);for(let a=0,n=i.length;a<n;a++){const n=i[a];S(t,n),T(t,n),n.lctFlag&&N(t,n.lctList);const r=s[a],o=r.length+Math.ceil(r.length/255);for(;t.ptr+1+o>=t.buf.length;)t.buf=P(t.buf);t.buf[t.ptr++]=e[a];let l=t.ptr;for(let e=0,i=r.length;e<i;e++)l===t.ptr&&t.ptr++,t.buf[t.ptr]=r[e],t.ptr-l!=255&&e+1!==i||(t.buf[l]=t.ptr-l,l=t.ptr+1),t.ptr++;t.buf[t.ptr++]=0}}))}(i,t.frames,t.header.gctSize),i.ptr>=i.buf.length&&(i.buf=P(i.buf)),i.buf[i.ptr]=59,i.ptr++,i.buf.slice(0,i.ptr)}))}function N(t,e){for(let i=0,a=e.length;i<a;i++)t.ptr+3>=t.buf.length&&(t.buf=P(t.buf)),t.buf[t.ptr++]=e[i][0],t.buf[t.ptr++]=e[i][1],t.buf[t.ptr++]=e[i][2]}function S(t,e){t.ptr+8>=t.buf.length&&(t.buf=P(t.buf)),t.buf[t.ptr++]=33,t.buf[t.ptr++]=249,t.buf[t.ptr++]=4,t.buf[t.ptr]=f(t.buf[t.ptr],2,3,e.disposalMethod),t.buf[t.ptr]=f(t.buf[t.ptr],1,1,Number(e.userInputFlag)),t.buf[t.ptr]=f(t.buf[t.ptr],0,1,Number(e.transColorFlag)),t.ptr++,t.buf[t.ptr++]=e.delay/10&255,t.buf[t.ptr++]=e.delay/10>>8,t.buf[t.ptr++]=e.transColorIdx,t.buf[t.ptr++]=0}function T(t,e){t.ptr+10>=t.buf.length&&(t.buf=P(t.buf)),t.buf[t.ptr++]=44,t.buf[t.ptr++]=255&e.left,t.buf[t.ptr++]=e.left>>8,t.buf[t.ptr++]=255&e.top,t.buf[t.ptr++]=e.top>>8,t.buf[t.ptr++]=255&e.width,t.buf[t.ptr++]=e.width>>8,t.buf[t.ptr++]=255&e.height,t.buf[t.ptr++]=e.height>>8,t.buf[t.ptr]=f(t.buf[t.ptr],7,1,Number(e.lctFlag)),t.buf[t.ptr]=f(t.buf[t.ptr],6,1,Number(e.interlace)),t.buf[t.ptr]=f(t.buf[t.ptr],2,1,Number(e.sortFlag)),t.buf[t.ptr]=f(t.buf[t.ptr],0,3,g(e.lctSize)-1),t.ptr++}function P(t){return function(t,e){if(e||(e=256),t instanceof Uint8Array){const i=new Uint8Array(t.length+e);return i.set(t),i}}(t,1048576)}function j(t,e,i){return 4*(i*t.width+e)}function k(t){return"number"==typeof t?Math.max(0,Math.min(t,255)):0}function R(t){let e=g(t.length);e<4&&(e=4);const i=Math.pow(2,e);for(let e=0;e<i;e++)t[e]||(t[e]=[0,0,0]);return t}const B={auto:!1,interactive:!0,skin:"basic",speed:1},Q=[.5,1,1.5,2],E=[0,0,0,255];function A(t,e){const i=t.frames[e];if(i.canvasImageData instanceof ImageData)return i.canvasImageData;const a=J(t,e),n=i.lctFlag?i.lctList:t.header.gctList,s=t.header.gctFlag?[...t.header.gctList[t.header.bgIndex],255]:[...E],r=t.header.width,o=t.header.height,l=H(i),d=new Uint8ClampedArray(r*o*4);for(let t=0,e=r*o;t<e;t++){const e=t%r,o=t/r>>0,h=t<<2;if(e>=i.left&&e<i.left+i.width&&o>=i.top&&o<i.top+i.height){const t=e-i.left+(o-i.top)*i.width;if(i.transColorFlag&&l[t]===i.transColorIdx)a&&(d[h]=a.data[h],d[h+1]=a.data[h+1],d[h+2]=a.data[h+2],d[h+3]=a.data[h+3]);else{const e=n[l[t]];d[h]=e[0],d[h+1]=e[1],d[h+2]=e[2],d[h+3]=255}}else a?(d[h]=a.data[h],d[h+1]=a.data[h+1],d[h+2]=a.data[h+2],d[h+3]=a.data[h+3]):(d[h]=s[0],d[h+1]=s[1],d[h+2]=s[2],d[h+3]=s[3])}const h=new ImageData(d,r,o);return i.canvasImageData=h,h}function O(t,e){const i=t.frames[e];if(i.rawImageData instanceof ImageData)return i.rawImageData;const a=i.lctFlag?i.lctList:t.header.gctList,n=H(i),s=new Uint8ClampedArray(i.width*i.height*4);for(let t=0;t<i.imageData.length;t++){const e=t<<2;if(i.transColorFlag&&n[t]===i.transColorIdx)s[e]=0,s[e+1]=0,s[e+2]=0,s[e+3]=0;else{const i=a[n[t]];s[e]=i[0],s[e+1]=i[1],s[e+2]=i[2],s[e+3]=255}}const r=new ImageData(i.width,i.height);return r.data.set(s),i.rawImageData=r,r}function H(t){const e=new Uint8Array(t.imageData.length);let i=0;function a(a){for(let n=0;n<t.width;n++)e[i]=t.imageData[a*t.width+n],i++}if(t.interlace){let e=0;for(;e<t.height;)a(e),e+=8;for(e=4;e<t.height;)a(e),e+=8;for(e=2;e<t.height;)a(e),e+=4;for(e=1;e<t.height;)a(e),e+=2}else e.set(t.imageData);return e}function J(t,e){if(e<=0)return;const i=t.frames[e-1];if(0!==i.disposalMethod){if(2===i.disposalMethod){const a=t.header.gctFlag?[...t.header.gctList[t.header.bgIndex],255]:[...E];let n=i.canvasImageData;n||(n=A(t,e-1));const s=new ImageData(n.width,n.height);s.data.set(n.data);for(let e=i.top;e<i.top+i.height;e++)for(let n=i.left;n<i.left+i.width;n++){const i=e*t.header.width+n<<2;s.data[i]=a[0],s.data[i+1]=a[1],s.data[i+2]=a[2],s.data[i+3]=a[3]}return s}return[1].includes(i.disposalMethod)?i.canvasImageData?i.canvasImageData:A(t,e-1):3===i.disposalMethod?J(t,e-1):void 0}}class U{constructor(t){this.keys=[],this.watch={},this.amzGif=t,this.cache={},this.init()}init(){this.dirtyChecking()}dirtyChecking(){const t=[];let a=null;Object.keys(this.watch).map((e=>{a=this.getValue(e),this.cache[e]!==a&&t.push({key:e,oldValue:this.cache[e],newValue:a})})),t.map((t=>e(this,void 0,void 0,(function*(){i(this.watch[t.key])&&(yield this.watch[t.key](t.newValue,t.oldValue))}))))}getValue(t){const e=t.split(".").filter((t=>t));let i=this.amzGif;for(let t=0;t<e.length&&(i=null==i?void 0:i[e[t]],void 0!==i);t++);return i}}class q extends U{constructor(t){super(t),this.playDiv=null,this.playImg=null,this.loadingDiv=null,this.loadingImg=null,this.loadingImgRoate=0,this.handlePlay=this.handlePlay.bind(this),this.dirtyChecking=this.dirtyChecking.bind(this),this.init(),this.setWatch()}init(){const t=this.amzGif._canvas.parentElement;if(!t)return void this.amzGif._errCall(u,"onError");const e=t.getBoundingClientRect(),i=this.genMask(e.width,e.height);i.style.zIndex="1",i.style.display="none",i.style.cursor="pointer",i.addEventListener("click",this.handlePlay.bind(this)),this.playDiv=i;const a=document.createElement("img");a.src="data:image/svg+xml;base64,PHN2ZyB0PSIxNjYyNzg5NjY0NjUyIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIzNjciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNMTI4IDEzOC42NjY2NjdjMC00Ny4yMzIgMzMuMzIyNjY3LTY2LjY2NjY2NyA3NC4xNzYtNDMuNTYyNjY3bDY2My4xNDY2NjcgMzc0Ljk1NDY2N2M0MC45NiAyMy4xNjggNDAuODUzMzMzIDYwLjggMCA4My44ODI2NjZMMjAyLjE3NiA5MjguODk2QzE2MS4yMTYgOTUyLjA2NCAxMjggOTMyLjU2NTMzMyAxMjggODg1LjMzMzMzM3YtNzQ2LjY2NjY2NnoiIGZpbGw9IiMzRDNEM0QiIHAtaWQ9IjIzNjgiPjwvcGF0aD48L3N2Zz4=",a.style.width="60px",a.style.height="60px",a.style.opacity="0.6",this.playImg=a,i.appendChild(a),t.appendChild(i);const n=this.genMask(e.width,e.height);this.loadingDiv=n,n.style.zIndex="2",n.style.display="none";const s=document.createElement("img");this.loadingImg=s,s.src="data:image/svg+xml;base64,PHN2ZyB0PSIxNjYyNzg5NzI0Njc4IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM0NDEiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNNTEyLjUxMSAyMS40ODNjLTI3MS4xNjMgMC00OTEuMDI4IDIxOS44Ni00OTEuMDI4IDQ5MS4wMjggMCAyNzEuMTczIDIxOS44NTYgNDkxLjAzIDQ5MS4wMjggNDkxLjAzIDI2LjU1NCAwIDQ4LjA4LTIxLjUyNyA0OC4wOC00OC4wOCAwLTI2LjU1NC0yMS41MjYtNDguMDgtNDguMDgtNDguMDgtMjE4LjA2NSAwLTM5NC44NjktMTc2LjgwNC0zOTQuODY5LTM5NC44NyAwLTIxOC4wNiAxNzYuODEzLTM5NC44NjkgMzk0Ljg3LTM5NC44NjkgMjE4LjA2NSAwIDM5NC44NjkgMTc2LjgwNCAzOTQuODY5IDM5NC44NyAwIDI2LjU1MyAyMS41MjYgNDguMDggNDguMDggNDguMDggMjYuNTUzIDAgNDguMDgtMjEuNTI3IDQ4LjA4LTQ4LjA4IDAtMjcxLjE3My0yMTkuODU3LTQ5MS4wMy00OTEuMDMtNDkxLjAzeiIgcC1pZD0iMzQ0MiI+PC9wYXRoPjwvc3ZnPg==",s.style.width="60px",s.style.height="60px",s.style.opacity="0.6",n.appendChild(s),t.appendChild(n),this.amzGif._rAFCallbackQueue.push(this.dirtyChecking.bind(this))}genMask(t,e){const i=document.createElement("div");return i.style.backgroundColor="rgba(0, 0, 0, 0.3)",i.style.width=t+"px",i.style.height=e+"px",i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i}setWatch(){this.watch.isPlaying=t=>{this.playDiv&&(this.playDiv.style.display=t||this.amzGif.isLoading?"none":"flex")},this.watch.isLoading=t=>{this.loadingDiv&&(this.loadingDiv.style.display=t?"flex":"none",t&&this.loadingImg&&(this.loadingImg.style.transform=`rotate(${this.loadingImgRoate+=1}deg)`))}}handlePlay(){this.amzGif.isPlaying||this.amzGif.play()}}function $(t,e,i,a,n){let s=0;for(let r=0;r<a;r++)(e<0||i<0||e>=t.width||i>=t.height)&&(e<0?e=0:e>=t.width&&(e=t.width-1),i<0?i=0:i>=t.height&&(i=t.height-1)),s+=t.data[j(t,e,i)+n],i++;return s}var tt={grayscale:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=.3*t.data[e]+.59*t.data[e+1]+.11*t.data[e+2]>>0;t.data[e]=t.data[e+1]=t.data[e+2]=i}return t},blackAndWhite:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=(t.data[e]+t.data[e+1]+t.data[e+2])/3;t.data[e]=t.data[e+1]=t.data[e+2]=i>=100?255:0}return t},reverse:function(t){for(let e=0,i=t.data.length;e<i;e+=4)t.data[e]=255-t.data[e],t.data[e+1]=255-t.data[e+1],t.data[e+2]=255-t.data[e+2];return t},decolorizing:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=(Math.min(t.data[e],t.data[e+1],t.data[e+2])+Math.max(t.data[e],t.data[e+1],t.data[e+2]))/2>>0;t.data[e]=t.data[e+1]=t.data[e+2]=i}return t},monochromeRed:function(t){for(let e=0,i=t.data.length;e<i;e+=4)t.data[e+1]=t.data[e+2]=0;return t},monochromeGreen:function(t){for(let e=0,i=t.data.length;e<i;e+=4)t.data[e]=t.data[e+2]=0;return t},monochromeBlue:function(t){for(let e=0,i=t.data.length;e<i;e+=4)t.data[e]=t.data[e+1]=0;return t},nostalgic:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=t.data[e],a=t.data[e+1],n=t.data[e+2],s=.393*i+.769*a+.189*n,r=.349*i+.686*a+.168*n,o=.272*i+.534*a+.131*n;t.data[e]=Math.min(255,Math.max(0,s)),t.data[e+1]=Math.min(255,Math.max(0,r)),t.data[e+2]=Math.min(255,Math.max(0,o))}return t},cast:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=t.data[e],a=t.data[e+1],n=t.data[e+2],s=128*i/(a+n+1),r=128*a/(i+n+1),o=128*n/(a+i+1);t.data[e]=Math.min(255,Math.max(0,s)),t.data[e+1]=Math.min(255,Math.max(0,r)),t.data[e+2]=Math.min(255,Math.max(0,o))}return t},frozen:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=t.data[e],a=t.data[e+1],n=t.data[e+2],s=3*(i-a-n)/2,r=3*(a-i-n)/2,o=3*(n-a-i)/2;t.data[e]=Math.min(255,Math.max(0,s)),t.data[e+1]=Math.min(255,Math.max(0,r)),t.data[e+2]=Math.min(255,Math.max(0,o))}return t},comic:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=t.data[e],a=t.data[e+1],n=t.data[e+2];t.data[e]=Math.abs(a-n+a+i)*i/256,t.data[e+1]=Math.abs(n-a+n+i)*i/256,t.data[e+2]=Math.abs(n-a+n+i)*a/256}return t},brown:function(t){for(let e=0,i=t.data.length;e<i;e+=4){const i=t.data[e],a=t.data[e+1],n=t.data[e+2],s=.393*i+.769*a+.189*n,r=.349*i+.686*a+.168*n,o=.272*i+.534*a+.131*n;t.data[e]=Math.min(255,Math.max(0,s)),t.data[e+1]=Math.min(255,Math.max(0,r)),t.data[e+2]=Math.min(255,Math.max(0,o))}return t},boxBlur:function(t,e=5){const i=new ImageData(t.width,t.height);i.data.set(t.data);const a=(e=e%2?e:e+1)>>1,n=e*e;let s=0,r=0,o=0,l=0,d=0,h=0;const c=[0,0,0];for(let u=0,g=t.data.length;u<g;u+=4){s=u/4%t.width,r=u/4/t.width>>0,o=s-a,l=r-a;for(let r=0;r<3;r++){if(d=c[r],s)d-=$(t,o-1,l,e,r),d+=$(t,s+a,l,e,r);else{d=0;for(let i=o;i<=s+a;i++)d+=$(t,i,l,e,r)}c[r]=d,h=d/n>>0,h<0?h=0:h>255&&(h=255),i.data[u+r]=h}}return i}};t.GifPlayer=class{constructor(t){this.speedList=Q,this._imgEl=null,this._canvas=null,this._ctx=null,this._offscreenCanvas=null,this._offscreenCtx=null,this._gifBuffer=null,this.gifData=null,this._duration=0,this._currFrame=-1,this._repetitionTimes=0,this._repetition=0,this._time=0,this._rAFCallbackQueue=[],this.isLoading=!1,this.isPlaying=!1,this.isRendering=!1,this._config=Object.assign(Object.assign({},B),t),Q.includes(this._config.speed)||(this._config.speed=1),this._update=this._update.bind(this),this._renderFrame=this._renderFrame.bind(this),this._togglePlay=this._togglePlay.bind(this),this._init()}_init(){if(this._config.el){if(this._config.el instanceof HTMLImageElement&&(this._imgEl=this._config.el),"string"==typeof this._config.el){const t=document.querySelector(this._config.el);if(!t)return void this._errCall(d+this._config.el,"onError");if(!(t instanceof HTMLImageElement))return void this._errCall(h(this._config.el),"onError");this._imgEl=t}setTimeout((()=>{this._initCanvas(),this._initContainer(),function(t){if(t._config.interactive&&"basic"===t._config.skin)new q(t)}(this),!0===this._config.auto&&this.play(),this._rAFCallbackQueue.push(this._update),function(t){const e=1e3/60;let i=0,a=performance.now(),n=a,s=a,r=0,o=0;i=window.requestAnimationFrame((function l(d){e<=d-a&&(n=d-(d-a)%e,r=n-a,o=d-s,a=n,s=d,t.map((t=>{t(d,r,o)}))),i=window.requestAnimationFrame(l)}))}(this._rAFCallbackQueue)}))}else this._errCall(l,"onError")}_initCanvas(){var t,e,i,a,n,s,r;const o=this._imgEl,l=o.getBoundingClientRect();this._config.width="number"==typeof this._config.width?this._config.width:null!==(t=null==l?void 0:l.width)&&void 0!==t?t:0,this._config.height="number"==typeof this._config.height?this._config.height:null!==(e=null==l?void 0:l.height)&&void 0!==e?e:0,this._canvas=document.createElement("canvas"),this._canvas.style.cursor="pointer",this._canvas.addEventListener("click",this._togglePlay),this._canvas.width=this._config.width,this._canvas.height=this._config.height,this._canvas.style.width=this._config.width+"px",this._canvas.style.height=this._config.height+"px",this._ctx=this._canvas.getContext("2d"),this._ctx.globalCompositeOperation="copy",null===(i=this._ctx)||void 0===i||i.drawImage(o,0,0,null!==(a=null==l?void 0:l.width)&&void 0!==a?a:this._config.width,null!==(n=null==l?void 0:l.height)&&void 0!==n?n:this._config.height,0,0,null!==(s=this._config.width)&&void 0!==s?s:null==l?void 0:l.width,null!==(r=this._config.height)&&void 0!==r?r:null==l?void 0:l.height)}_initContainer(){var t;const e=this._imgEl,i=document.createElement("div");e.id&&(i.id=e.id),i.style.width=this._config.width+"px",i.style.height=this._config.height+"px",i.style.position="relative",i.style.display="inline-block",this._canvas&&(i.appendChild(this._canvas),null===(t=e.parentElement)||void 0===t||t.replaceChild(i,e))}restart(t){return e(this,void 0,void 0,(function*(){this._config=Object.assign(Object.assign(Object.assign({},this._config),t),{el:this._config.el}),yield this.pause(),this._gifBuffer=null,this.gifData=null,this._duration=0,this._currFrame=-1,this._time=0,this._repetition=0,yield this.play()}))}play(){var t,a,n;return e(this,void 0,void 0,(function*(){if(null===this._gifBuffer){if(!this._config.src&&!i(this._config.httpRequest))return this._errCall(s,"onError");yield this._getGif().catch((t=>this._errCall(t.message,"onLoadError")))}if(null!==this._gifBuffer){if(null===this.gifData){const e=yield K(this._gifBuffer,this._errCall);if(!e||!e.header.isGif)return;this.gifData=e,this._duration=e.frames.reduce(((t,e)=>t+(e.gceFlag?e.delay||0:100)),0),!0===this._config.loop?this._repetitionTimes=0:!1===this._config.loop?this._repetitionTimes=1:this._repetitionTimes=(null===(t=e.appExt)||void 0===t?void 0:t.repetitionTimes)||0,this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=null===(a=this.gifData)||void 0===a?void 0:a.header.width,this._offscreenCanvas.height=null===(n=this.gifData)||void 0===n?void 0:n.header.height,this._offscreenCtx=this._offscreenCanvas.getContext("2d")}if(i(this._config.onBeforePlay)){if(!(yield this._config.onBeforePlay()))return}this._checkEnd()&&(this._repetition=0),this.isPlaying=!0,i(this._config.onPlay)&&this._config.onPlay()}}))}pause(){return e(this,void 0,void 0,(function*(){if(i(this._config.onBeforePause)){if(!(yield this._config.onBeforePause()))return}this.isPlaying=!1,i(this._config.onPause)&&this._config.onPause()}))}nextFrame(){return this.gifData&&this._ctx&&this._offscreenCtx?this.isRendering?c:(this._currFrame=(this._currFrame+1)%this.gifData.frames.length,this._renderFrame(),void this._syncGIFTime()):this._errCall(a,"onError")}prevFrame(){return this.gifData&&this._ctx&&this._offscreenCtx?this.isRendering?c:(this._currFrame--,this._currFrame<0&&(this._currFrame=this.gifData.frames.length-1),this._renderFrame(),void this._syncGIFTime()):this._errCall(a,"onError")}jump(t){return this.gifData?"number"!=typeof t?this._errCall(n,"onError"):this.isRendering?c:((t<0||t>this.gifData.frames.length-1)&&(t=0),this._currFrame=t,this._renderFrame(),void(this._time=performance.now())):this._errCall(a,"onError")}setSpeed(t){return!!this.speedList.includes(t)&&(this._config.speed=t,!0)}_syncGIFTime(){var t,e;if(-1===this._currFrame)this._time=0;else{this._time=0;for(let i=0;i<this._currFrame;i++)this._time+=(null===(e=null===(t=this.gifData)||void 0===t?void 0:t.frames[this._currFrame])||void 0===e?void 0:e.delay)||0}}_getFrameIndexByTime(){if(this._duration<=this._time)return this.gifData.frames.length-1;{let t=0,e=0;for(;t<=this._time;){const i=this.gifData.frames[e];t+=i.gceFlag?i.delay:100,e++}return e-1}}_togglePlay(){!1!==this._config.interactive&&(this.isPlaying?this.pause():this.play())}_update(t,e){if(this.isPlaying&&!this.isRendering&&this.gifData&&this._ctx&&this._offscreenCtx&&!document.hidden){if(this._time+=e*this._config.speed,0===this._duration?this._time=0:(this._repetition+=this._time/this._duration>>0,this._time%=this._duration),this._currFrame=this._getFrameIndexByTime(),this._renderFrame(),this._checkEnd())return this.isPlaying=!1,void(i(this._config.onEnd)&&this._config.onEnd());this._renderFrame()}}_renderFrame(){const t=this.gifData,e=this._ctx,a=this._offscreenCtx;this.isRendering=!0,function(t,e,a,n,s){let r=A(a,n);if(i(s)){let t=new ImageData(r.width,r.height);t.data.set(r.data),t=s(t),r=t}e.putImageData(r,0,0),t.drawImage(e.canvas,0,0,r.width,r.height,0,0,t.canvas.width,t.canvas.height)}(e,a,t,this._currFrame,(t=>i(this._config.filter)?this._config.filter(t):t)),this.isRendering=!1}_checkEnd(){return!(!this._repetitionTimes||this._repetitionTimes>this._repetition)}_getGif(){return e(this,void 0,void 0,(function*(){if(this.isLoading=!0,i(this._config.httpRequest))try{const t=yield this._config.httpRequest(this._config.src);this._gifBuffer=yield t.arrayBuffer()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}else try{const t=yield fetch(this._config.src);this._gifBuffer=yield t.arrayBuffer(),i(this._config.onLoad)&&this._config.onLoad()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}this.isLoading=!1}))}_errCall(t,e){var a,n,s,r;if(i(this._config[e]))null===(n=(a=this._config)[e])||void 0===n||n.call(a,t);else{if(!i(this._config.onError))throw new Error(t);null===(r=(s=this._config).onError)||void 0===r||r.call(s,t)}}},t.build=function(t){return e(this,void 0,void 0,(function*(){t=Object.assign({repetition:0,dithering:!0},t);const e={header:{type:"GIF",isGif:!0,version:"89a",width:0,height:0,gctFlag:!0,cr:7,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0,gctList:[]},appExt:{appName:"NETSCAPE",blockIdx:1,startByte:0,endByte:0,verification:"2.0",repetitionTimes:0},frames:[]};let i=0;const a=[[]];t.frames.map(((t,e)=>{t.setLocalColorTable?a.push([{frameIdx:e,frameData:t}]):a[0].push({frameIdx:e,frameData:t})}));const n=yield Promise.all(a.map((e=>_({action:"colorTransform",param:[e.map((t=>t.frameData)),t.dithering]}))));console.log("quantizedFrames: ",n),a.map(((t,i)=>{t.map(((t,a)=>{e.frames[t.frameIdx]={},e.frames[t.frameIdx].imageData=n[i].frames[a].indices,0===i?e.header.gctList=n[i].colorTable:e.frames[t.frameIdx].lctList=n[i].colorTable}))}));const s=function(...t){return{x:Math.max(...t.map((t=>t.width))),y:Math.max(...t.map((t=>t.height)))}}(...t.frames.map((t=>t.imageData)));e.header.width=s.x,e.header.height=s.y;let r,o=[0,0,0];return t.backgroundColor&&(o=function(t){const e=new Array(4).fill(0);e[3]=1;const i=t.replace(/ /g,"");if(i)if(i.startsWith("#")){const t=parseInt(i.substring(1),16);if(4===i.length){if(!(t>=0&&t<=4095))return e;e[0]=(3840&t)>>4|(3840&t)>>8,e[1]=240&t|(240&t)>>4,e[2]=15&t|(15&t)<<4}else if(7===i.length){if(!(t>=0&&t<=16777215))return e;e[0]=(16711680&t)>>16,e[1]=(65280&t)>>8,e[2]=255&t}}else{const t=i.indexOf("("),a=i.indexOf(")");if(-1!==t&&a+1===i.length){const n=i.substring(0,t),s=i.substring(t+1,a).split(",");let r=1;switch(n){case"rgba":4===s.length&&(r=255*parseFloat(s.pop()),r=k(r),e[3]=r);case"rgb":3===s.length&&(e[0]=k(parseInt(s[0])),e[1]=k(parseInt(s[1])),e[2]=k(parseInt(s[2])))}}}return e}(t.backgroundColor)),i=e.header.gctList.length-1,e.header.bgIndex=e.header.gctList.length,e.header.gctList.push([o[0],o[1],o[2]]),e.header.gctList=R(e.header.gctList),e.header.gctSize=e.header.gctList.length,e.appExt&&"number"==typeof t.repetition&&(e.appExt.repetitionTimes=t.repetition),e.frames.forEach(((a,n)=>{var s;const r=t.frames[n];a.startByte=0,a.endByte=0,a.width=r.imageData.width,a.height=r.imageData.height,a.left=(e.header.width-a.width)/2>>0,a.top=(e.header.height-a.height)/2>>0,a.disposalMethod=r.disposalMethod||1,a.userInputFlag=!1,a.transColorFlag=!0,a.delay=null!==(s=r.delay)&&void 0!==s?s:10,a.lctList=a.lctList||[],a.lctFlag=!!a.lctList.length,a.interlace=!1,a.sortFlag=!1,a.transColorIdx=a.lctFlag?a.lctList.length-1:i,a.lctList=a.lctFlag?R(a.lctList):[],a.lctSize=a.lctList.length,a.codeSize=g(a.lctSize),a.imageStartByte=0,a.imageEndByte=0})),t.optimizeFrames&&(r=yield _({action:"replaceRepeatedIndices",param:[e]})),new Promise((t=>{Promise.all([V(e),r?V(r):void 0].filter((t=>t))).then((e=>{const i=e[0],a=e[1];a&&i.length>a.length?t(a):t(i)}))}))}))},t.decode=K,t.encode=V,t.filters=tt,t.getCompositedFrameImageData=A,t.getCompositedFramesImageData=function(t){return t.frames.map(((e,i)=>A(t,i)))},t.getFrameImageData=O,t.getFramesImageData=function(t){return t.frames.map(((e,i)=>O(t,i)))}}));
