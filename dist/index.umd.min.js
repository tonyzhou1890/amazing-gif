!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).AMZGif=e()}(this,function(){"use strict";function t(t,s,o,h){return new(o=o||Promise)(function(i,e){function r(t){try{a(h.next(t))}catch(t){e(t)}}function n(t){try{a(h.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?i(t.value):((e=t.value)instanceof o?e:new o(function(t){t(e)})).then(r,n)}a((h=h.apply(t,s||[])).next())})}function h(t){return"function"==typeof t}function m(t,e,i){return t>>e&(1<<i)-1}const l={decode:(t,e)=>{function i(){return new Array(2**t+2).fill(0).map((t,e)=>String.fromCharCode(e))}let r=i();var n=2**t,a=2**t+1;let s=t+1,o="",h=!0;var l=e.length;let f=0,c=0,g=s,d=0,p="",u=0;for(;f<l;){for(g=s,d=0;0!==g;)8-c>=g?(d+=m(e[f],c,g)<<s-g,c+=g,g=0):(d+=m(e[f],c,8-c)<<s-g,g-=8-c,c=8),8===c&&(f++,c=0);if(d===a)break;d===n?(r=i(),s=t+1,h=!0):(void 0!==r[d]?h?(o+=r[d],u=d,h=!1):(o+=r[d],p=r[d][0],r.push(r[u]+p),u=d):(p=r[u][0],o+=r[u]+p,r.push(r[u]+p),u=d),r.length>=2**s&&s<12&&s++)}let _=new Uint8Array(o.length);for(let t=0;t<o.length;t++)_[t]=o.charCodeAt(t);return _}};function i(t,e){if(!(t instanceof ArrayBuffer)){if(h(e))return e("gif 数据类型错误");throw new Error("gif 数据类型错误")}var i=new Uint8Array(t);const r={ptr:0},n={header:{type:"",isGif:!1,version:"",width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0,gctList:[]},frames:[]};for(;r.ptr<i.length;){if(0===r.ptr){var a=function(e,t){const i={type:"",isGif:!1,version:""};for(let t=0;t<3;t++)i.type+=String.fromCharCode(e[t]);if(i.isGif=i.type==="GIF",i.isGif){for(let t=3;t<6;t++)i.version+=String.fromCharCode(e[t]);t.ptr=5}return i}(i,r);if(!a.isGif)return e("文件非 gif");Object.assign(n.header,a)}else if(6===r.ptr){var a=function(t,e){const i={width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0};i.width=t[6]+(t[7]<<8),i.height=t[8]+(t[9]<<8),i.gctFlag=Boolean(t[10]>>7),i.cr=112&t[10],i.sortFlag=Boolean(8&t[10]),i.gctSize=Math.pow(2,1+(7&t[10])),i.gctFlag&&(i.gctStartByte=13,i.gctEndByte=13+3*i.gctSize-1);return i.bgIndex=t[11],i.pixelAspect=t[12],e.ptr=12,i}(i,r),s=(Object.assign(n.header,a),a.gctFlag?(++r.ptr,function(e,t,i){const r=3*t,n=13+r,a=[];for(let t=13;t<n;t+=3)a.push([e[t],e[t+1],e[t+2]]);return i.ptr=n-1,a}(i,a.gctSize,r)):[]);n.header.gctList=s}else if(r.ptr+1<i.length&&33===i[r.ptr]&&255===i[r.ptr+1]&&!n.appExt){s=function(e,t){const i={appName:"",repetitionTimes:0,startByte:0,endByte:0};i.startByte=t.ptr;let r=i.startByte;var n=e[r+=2];r++;for(let t=0;t<n-3;t++)i.appName+=String.fromCharCode(e[r+t]);r+=n;var a=e[r];return i.endByte=r+a,i.repetitionTimes=e[r+=2],t.ptr=i.endByte,i}(i,r);n.appExt=s}else if(r.ptr+1<i.length&&33===i[r.ptr]&&249===i[r.ptr+1])n.frames.push(f(i,r));else if(44===i[r.ptr]){let t=f(i,r);var o=n.frames[n.frames.length-1];o.endByte?n.frames.push(t):(t.startByte=o.startByte,t.disposalMethod=o.disposalMethod,t.userInputFlag=o.userInputFlag,t.transColorFlag=o.transColorFlag,t.delay=o.delay,t.transColorIdx=o.transColorIdx,n.frames[n.frames.length-1]=t)}else if(r.ptr+1<i.length&&33===i[r.ptr]&&1===i[r.ptr+1])n.frames.push(f(i,r));else if(59===i[r.ptr])break;r.ptr++}return console.log(n),n}function f(r,t){const n={startByte:t.ptr,endByte:0,width:0,height:0,left:0,top:0,disposalMethod:0,userInputFlag:!1,transColorFlag:!1,delay:0,transColorIdx:0,lctFlag:!1,interlace:!1,sortFlag:!1,lctSize:0,lctStartByte:0,lctEndByte:0,lctList:[],imageData:new Uint8Array,imageStartByte:0,imageEndByte:0};if(33===r[t.ptr]&&249===r[t.ptr+1]&&(t.ptr+=2,a=r[t.ptr],a=t.ptr+a+1,t.ptr++,n.disposalMethod=28&r[t.ptr],n.userInputFlag=Boolean(2&r[t.ptr]),n.transColorFlag=Boolean(1&r[t.ptr]),n.delay=10*(r[++t.ptr]+(r[++t.ptr]<<8)),n.transColorIdx=r[++t.ptr],(0!==r[++t.ptr]||t.ptr>a)&&(t.ptr=a)),44===r[t.ptr]){if(n.left=r[++t.ptr]+(r[++t.ptr]<<8),n.top=r[++t.ptr]+(r[++t.ptr]<<8),n.width=r[++t.ptr]+(r[++t.ptr]<<8),n.height=r[++t.ptr]+(r[++t.ptr]<<8),n.lctFlag=Boolean(128&r[++t.ptr]),n.interlace=Boolean(64&r[t.ptr]),n.sortFlag=Boolean(32&r[t.ptr]),n.lctSize=Math.pow(2,1+(7&r[t.ptr])),n.lctFlag){n.lctStartByte=t.ptr+1,n.lctEndByte=t.ptr+3*n.lctSize;for(let t=n.lctStartByte;t<n.lctEndByte;t+=3)n.lctList.push([r[t],r[t+1],r[t+2]]);t.ptr=n.lctEndByte}t.ptr++,n.imageStartByte=t.ptr;var a=r[t.ptr++];const h=[];let e=0;for(;0!==r[t.ptr]&&void 0!==r[t.ptr];){var s=r[t.ptr++],o=r.slice(t.ptr,t.ptr+s);e+=o.length,h.push(o),t.ptr+=s}n.imageEndByte=t.ptr,n.endByte=t.ptr;let i=new Uint8Array(e);for(let t=h.length-1;0<=t;t--)i.set(h[t],e-=h[t].length);n.imageData=l.decode(a,i)}return n}function e(i){var t=performance.now();let r=0,n=t;r=window.requestAnimationFrame(function t(e){1e3/60<=e-n&&(n=e-(e-n)%(1e3/60),i(e)),r=window.requestAnimationFrame(t)})}function a(i,r,n){if(r.canvasImageData instanceof ImageData)return r.canvasImageData;var a=r.lctFlag?r.lctList:i.header.gctList,t=i.header.gctFlag?[...i.header.gctList[i.header.bgIndex],255]:null,s=i.header.width,i=i.header.height;if(!n){const p=new Uint8ClampedArray(s*i*4);var o=t||[0,0,0,255];for(let t=0,e=s*i;t<e;t+=4)p[t]=o[0],p[t+1]=o[1],p[t+2]=o[2],p[t+2]=o[3];n=new ImageData(p,s,i)}const h=new Uint8Array(r.imageData.length);if(r.interlace){let e=0,i=0;function l(){for(let t=0;t<r.width;t++)h[i]=r.imageData[e*r.width+t],i++}for(;e<r.height;)l(),e+=8;for(e=4;e<r.height;)l(),e+=8;for(e=2;e<r.height;)l(),e+=4;for(e=1;e<r.height;)l(),e+=2}else h.set(r.imageData);const f=new Uint8ClampedArray(s*i*4);for(let t=0,e=s*i;t<e;t++){var c=t%s,g=t/s>>0,d=4*t;!(c>=r.left&&c<=r.left+r.width&&g>=r.top&&g<=r.top+r.height)||r.transColorFlag&&h[t]===r.transColorIdx?(f[d]=n.data[d],f[1+d]=n.data[1+d],f[2+d]=n.data[2+d],f[3+d]=n.data[3+d]):(c=c-r.left+(g-r.top)*r.width,g=a[h[c]],f[d]=g[0],f[1+d]=g[1],f[2+d]=g[2],f[3+d]=255)}t=new ImageData(f,s,i);return r.canvasImageData=t}function n(t,e,i,r){var n=i.frames[r],r=function t(e,i){if(!(i<=0)){var r=e.frames[i-1];if(0!==r.disposalMethod&&2!==r.disposalMethod)return[1,4,5,6,7].includes(r.disposalMethod)?r.canvasImageData||a(e,r,t(e,i-1)):3===r.disposalMethod?t(e,i-2):void 0}}(i,r),i=a(i,n,r);e.putImageData(i,0,0),t.drawImage(e.canvas,0,0,i.width,i.height,0,0,t.canvas.width,t.canvas.height)}const r={loop:!0,auto:!1,interface:!0,skin:"basic",speed:1},s=[.5,1,1.5,2];return class{constructor(t){this._gifLoading=!1,this._frameTotal=0,this._currFrame=-1,this._nextUpdateTime=performance.now(),this.isPlaying=!1,this._config=Object.assign(Object.assign({},r),t),s.includes(this._config.speed)||(this._config.speed=1),this._imgEl=null,this._canvas=null,this._ctx=null,this._offscreenCanvas=null,this._offscreenCtx=null,this._gifBuffer=null,this.gifData=null,this._update=this._update.bind(this),this._renderFrame=this._renderFrame.bind(this),this._togglePlay=this._togglePlay.bind(this),this._init()}_init(){if(this._config.el){if(this._config.el instanceof HTMLImageElement&&(this._imgEl=this._config.el),"string"==typeof this._config.el){var t=document.querySelector(this._config.el);if(!t)return void this._errCall("未找到 img 元素 "+this._config.el,"onError");if(!(t instanceof HTMLImageElement))return void this._errCall("元素 "+this._config.el+" 不是图片","onError");this._imgEl=t}this._initCanvas(),this._initContainer(),!0===this._config.auto&&this.play(),e(this._update)}else this._errCall("未指定 img 元素","onError")}_initCanvas(){var t;const e=this._imgEl,i=e.getBoundingClientRect();this._config.width="number"==typeof this._config.width?this._config.width:null!=(t=null===i||void 0===i?void 0:i.width)?t:0,this._config.height="number"==typeof this._config.height?this._config.height:null!=(t=null===i||void 0===i?void 0:i.height)?t:0,this._canvas=document.createElement("canvas"),this._canvas.addEventListener("click",this._togglePlay),this._canvas.width=this._config.width,this._canvas.height=this._config.height,this._canvas.style.width=this._config.width+"px",this._canvas.style.height=this._config.height+"px",this._ctx=this._canvas.getContext("2d"),this._ctx.globalCompositeOperation="copy",e.addEventListener("load",()=>{var t;null!=(t=this._ctx)&&t.drawImage(e,0,0,null!=(t=null===i||void 0===i?void 0:i.width)?t:this._config.width,null!=(t=null===i||void 0===i?void 0:i.height)?t:this._config.height,0,0,null!=(t=this._config.width)?t:null===i||void 0===i?void 0:i.width,null!=(t=this._config.height)?t:null===i||void 0===i?void 0:i.height)})}_initContainer(){var t,e=this._imgEl;const i=document.createElement("div");i.style.width=this._config.width+"px",i.style.height=this._config.height+"px",i.style.position="relative",i.style.display="inline-block",this._canvas&&(i.appendChild(this._canvas),null!=(t=e.parentElement)&&t.replaceChild(i,e))}play(){var e;return t(this,void 0,void 0,function*(){if(null===this._gifBuffer){if(!this._config.src)return this._errCall("未指定 gif 图片地址","onError");yield this._getGif().catch(t=>this._errCall(t.message,"onLoadError"))}if(null===this._gifBuffer)this._errCall("gif 不存在","onDataError");else{if(null===this.gifData){var t=i(this._gifBuffer,this._errCall);if(!t||!t.header.isGif)return;this.gifData=t,this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=null==(e=this.gifData)?void 0:e.header.width,this._offscreenCanvas.height=null==(e=this.gifData)?void 0:e.header.height,this._offscreenCtx=this._offscreenCanvas.getContext("2d")}if(h(this._config.onBeforePlay))if(!(yield this._config.onBeforePlay()))return;this.isPlaying=!0,this._nextUpdateTime=Math.max(this._nextUpdateTime,performance.now()),h(this._config.onPlay)&&this._config.onPlay()}})}pause(){return t(this,void 0,void 0,function*(){if(h(this._config.onBeforePause)&&!(yield this._config.onBeforePause()))return;this.isPlaying=!1,h(this._config.onPause)&&this._config.onPause()})}_togglePlay(){!1!==this._config.interactive&&(this.isPlaying?this.pause():this.play())}_update(t){if(this.isPlaying&&this.gifData&&this._ctx&&this._offscreenCtx&&!document.hidden&&!(this._nextUpdateTime>t||(this._currFrame++,this._checkEnd())))for(this._renderFrame();this._nextUpdateTime<=t;)this._nextUpdateTime+=Math.max(this.gifData.frames[this._currFrame].delay/this._config.speed,1),this._nextUpdateTime<=t&&(this._currFrame++,this._checkEnd()&&(this._currFrame=this.gifData.frames.length-1,this._renderFrame()))}_renderFrame(){var t=this.gifData,e=this._ctx,i=this._offscreenCtx,r=this.isPlaying;this.isPlaying=!1,n(e,i,t,this._currFrame),this.isPlaying=r}_checkEnd(){if(this._currFrame>this.gifData.frames.length-1){if(!1===this._config.loop)return this.isPlaying=!1,h(this._config.onEnd)&&this._config.onEnd(),!0;this._currFrame=0}}nextFrame(){if(!this.gifData||!this._ctx||!this._offscreenCtx)return this._errCall("数据未就绪","onError");this._currFrame=(this._currFrame+1)%this.gifData.frames.length,this._renderFrame(),this._nextUpdateTime=performance.now()+this.gifData.frames[this._currFrame].delay/this._config.speed}prevFrame(){if(!this.gifData||!this._ctx||!this._offscreenCtx)return this._errCall("数据未就绪","onError");this._currFrame--,this._currFrame<0&&(this._currFrame=this.gifData.frames.length-1),this._renderFrame(),this._nextUpdateTime=performance.now()+this.gifData.frames[this._currFrame].delay/this._config.speed}_getGif(){return t(this,void 0,void 0,function*(){if(this._gifLoading=!0,h(this._config.httpRequest))try{const t=yield this._config.httpRequest(this._config.src);this._gifBuffer=yield t.arrayBuffer()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}else try{const e=yield fetch(this._config.src);this._gifBuffer=yield e.arrayBuffer()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}this._gifLoading=!1})}_errCall(t,e){var i;if(h(this._config[e]))null!=(e=(i=this._config)[e])&&e.call(i,t);else{if(!h(this._config.onError))throw new Error(t);null!=(i=(e=this._config).onError)&&i.call(e,t)}}}});
