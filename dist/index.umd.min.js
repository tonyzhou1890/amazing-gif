!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).AMZGif=e()}(this,function(){"use strict";function s(t,s,o,h){return new(o=o||Promise)(function(i,e){function a(t){try{n(h.next(t))}catch(t){e(t)}}function r(t){try{n(h.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?i(t.value):((e=t.value)instanceof o?e:new o(function(t){t(e)})).then(a,r)}n((h=h.apply(t,s||[])).next())})}function d(t){return"function"==typeof t}const c={notReady:"数据未就绪",wrongParam:"参数错误",noGifUrl:"未指定 gif 图片地址",gifEmpty:"gif 不存在",gifDataTypeError:"gif 数据类型错误",notGif:"文件非 gif",noConfigEl:"未指定 img 元素",noImg:"未找到 img 元素",notImg:t=>`元素 ${t} 不是图片`,isRendering:"isRendering",skinError:"皮肤出错",skinContainerIsSmall:"空间不足以显示皮肤",errData:"数据格式错误"};function g(t){let e=1;for(;t>2**e;)e++;return e}function f(t,e,i,a){return((1<<i)-1&a)<<e|t}const e={loop:!0,auto:!1,interactive:!0,skin:"basic",speed:1},i=[.5,1,1.5,2],u=[0,0,0,255];var r=null;try{r=("undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads")).Worker}catch(t){}function t(t,e,i){var e=void 0===e?null:e,t=(i=void 0!==i&&i,Buffer.from(t,"base64").toString(i?"utf16":"utf8")),i=t.indexOf("\n",10)+1,a=t.substring(i)+(e?"//# sourceMappingURL="+e:"");return function(t){return new r(a,Object.assign({},t,{eval:!0}))}}function a(t,e,i){e=void 0===e?null:e,t=function(t,e){var i=atob(t);if(e){for(var a=new Uint8Array(i.length),r=0,n=i.length;r<n;++r)a[r]=i.charCodeAt(r);return String.fromCharCode.apply(null,new Uint16Array(a.buffer))}return i}(t,void 0!==i&&i),i=t.indexOf("\n",10)+1,t=t.substring(i)+(e?"//# sourceMappingURL="+e:""),i=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(i)}var n="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);o=null,h=!(P="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7ZnVuY3Rpb24gbShlLG4sdCl7cmV0dXJuIGU+Pm4mKDE8PHQpLTF9ZnVuY3Rpb24gdyhlLG4sdCxyKXtyZXR1cm4oKDE8PHQpLTEmcik8PG58ZX12YXIgZT17ZGVjb2RlOihlLG4pPT57ZnVuY3Rpb24gdCgpe3JldHVybiBuZXcgQXJyYXkoMioqZSsyKS5maWxsKDApLm1hcCgoZSxuKT0+U3RyaW5nLmZyb21DaGFyQ29kZShuKSl9bGV0IHI9dCgpO3ZhciBvPTIqKmUsbD0yKiplKzE7bGV0IGk9ZSsxLGE9IiIsYz0hMDt2YXIgcz1uLmxlbmd0aDtsZXQgZj0wLGc9MCx1PWksZD0wLGg9IiIscD0wO2Zvcig7ZjxzOyl7Zm9yKHU9aSxkPTA7MCE9PXUmJig4LWc+PXU/KGQrPW0obltmXSxnLHUpPDxpLXUsZys9dSx1PTApOihkKz1tKG5bZl0sZyw4LWcpPDxpLXUsdS09OC1nLGc9OCksISg4PT09ZyYmKGYrKyxnPTAsZj49cykpKTspO2lmKGQ9PT1sKWJyZWFrO2Q9PT1vPyhyPXQoKSxpPWUrMSxjPSEwKToodm9pZCAwIT09cltkXT9jPyhhKz1yW2RdLHA9ZCxjPSExKTooYSs9cltkXSxoPXJbZF1bMF0sci5wdXNoKHJbcF0raCkscD1kKToodm9pZCAwPT09cltwXSYmY29uc29sZS5sb2cocCxhLmxlbmd0aCksaD1yW3BdWzBdLGErPXJbcF0raCxyLnB1c2gocltwXStoKSxwPWQpLHIubGVuZ3RoPj0yKippJiZpPDEyJiZpKyspfWxldCB3PW5ldyBVaW50OEFycmF5KGEubGVuZ3RoKTtmb3IobGV0IGU9MDtlPGEubGVuZ3RoO2UrKyl3W2VdPWEuY2hhckNvZGVBdChlKTtyZXR1cm4gd30sZW5jb2RlOihyLHQpPT57ZnVuY3Rpb24gbygpe2NvbnN0IHQ9bmV3IE1hcDtyZXR1cm4gbmV3IEFycmF5KDIqKnIpLmZpbGwoMCkubWFwKChlLG4pPT57dC5zZXQoU3RyaW5nLmZyb21DaGFyQ29kZShuKSxuKX0pLHR9ZnVuY3Rpb24gbChlKXtsZXQgbj1zO2lmKHUrMj49Zy5sZW5ndGgpe2NvbnN0IHQ9bmV3IFVpbnQ4QXJyYXkoZy5sZW5ndGgrMjU2KTt0LnNldChnKSxnPXR9Zm9yKDtuOyk4LWQ+PW4/KGdbdV09dyhnW3VdLGQsbixlKSxkKz1uLG49MCk6KGdbdV09dyhnW3VdLGQsOC1kLGUpLGU+Pj04LWQsbi09OC1kLGQ9OCksOD09PWQmJihkPTAsdSsrKX1sZXQgaT1vKCk7dmFyIGE9MioqcixlPTIqKnIrMTtsZXQgYz0yKipyKzIscz1yKzEsZj0yKipzO2xldCBnPW5ldyBVaW50OEFycmF5KDI1NiksdT0wLGQ9MCxoPSIiLHA9IiI7bChhKTtmb3IobGV0IGU9MCxuPXQubGVuZ3RoO2U8bjtlKyspcD1TdHJpbmcuZnJvbUNoYXJDb2RlKHRbZV0pLGkuaGFzKGgrcCk/aCs9cDoobChpLmdldChoKSksNDA5Mz09PWM/KGwoYSksaT1vKCksYz0yKipyKzIscz1yKzEsZj0yKipzKTooYz09PWYmJihzKyssZj0yKipzKSxpLnNldChoK3AsYysrKSksaD1wLHA9IiIpO2gmJmwoaS5nZXQoaCkpLGwoZSk7bGV0IG49bnVsbDtyZXR1cm4gbj1kP2cuc2xpY2UoMCx1KzEpOmcuc2xpY2UoMCx1KX19O2NvbnN0IHI9e2dpZkx6d0RlY29kZTplLmRlY29kZSxnaWZMendFbmNvZGU6ZS5lbmNvZGV9O29ubWVzc2FnZT1lPT57dmFye2FjdGlvbjplLHBhcmFtOm4sX3NpZ246dH09ZS5kYXRhOyJmdW5jdGlvbiI9PXR5cGVvZiByW2VdPyhlPXthY3Rpb246ZSxyZXN1bHQ6cltlXSguLi5udWxsIT1uP246W10pLF9zaWduOnR9LHBvc3RNZXNzYWdlKGUpKTpjb25zb2xlLmxvZygi5oyH5a6a5pON5L2c5LiN5a2Y5ZyoIil9fSgpOwovLyMgc291cmNlTWFwcGluZ1VSTD13b3JrZXJVdGlscy5qcy5tYXAKCg==");var o,h,l,p,m,y,b=n?t(P,o,h):(l=P,p=o,m=h,function(t){return y=y||a(l,p,m),new Worker(y,t)}),n=Math.max(window.navigator.hardwareConcurrency-1,1);const _=new Map,v=[],w=new Array(n).fill(null).map((t,e)=>({index:e,worker:new b,idle:!0}));function M(){let t=null;var e;v.length&&(t=w.find(t=>t.idle))&&(t.idle=!1,e=v.shift(),_.set(e._sign,e.p),t.worker.postMessage(Object.assign(Object.assign({},e.job),{_sign:e._sign}),e.job.transferable||[]))}w.map(e=>{e.worker.addEventListener("message",t=>{t.data&&t.data._sign?(_.get(t.data._sign).resolve(t.data.result),_.delete(t.data._sign),e.idle=!0,M()):(console.error("worker 返回数据错误"),_.get(t.data._sign).reject("worker 返回数据错误"))})});function C(h,l){return s(this,void 0,void 0,function*(){if(!(h instanceof ArrayBuffer)){if(d(l))return l(c.gifDataTypeError,"onDataError");throw new Error(c.gifDataTypeError)}var e=new Uint8Array(h);const i={ptr:0},a={header:{type:"",isGif:!1,version:"",width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0,gctList:[]},frames:[]};for(var t=window.performance.now();i.ptr<e.length;){if(0===i.ptr){var r=function(e,t){const i={type:"",isGif:!1,version:""};for(let t=0;t<3;t++)i.type+=String.fromCharCode(e[t]);if(i.isGif=i.type==="GIF",i.isGif){for(let t=3;t<6;t++)i.version+=String.fromCharCode(e[t]);t.ptr=5}return i}(e,i);if(!r.isGif)return l(c.notGif,"onDataError");Object.assign(a.header,r)}else if(6===i.ptr){var r=function(t,e){const i={width:0,height:0,gctFlag:!1,cr:0,sortFlag:!1,gctSize:0,gctStartByte:0,gctEndByte:0,bgIndex:0,pixelAspect:0};i.width=t[6]+(t[7]<<8),i.height=t[8]+(t[9]<<8),i.gctFlag=Boolean(t[10]>>7),i.cr=t[10]>>4&7,i.sortFlag=Boolean(8&t[10]),i.gctSize=Math.pow(2,1+(7&t[10])),i.gctFlag&&(i.gctStartByte=13,i.gctEndByte=13+3*i.gctSize-1);return i.bgIndex=t[11],i.pixelAspect=t[12],e.ptr=12,i}(e,i),n=(Object.assign(a.header,r),r.gctFlag?(++i.ptr,function(e,t,i){const a=3*t,r=13+a,n=[];for(let t=13;t<r;t+=3)n.push([e[t],e[t+1],e[t+2]]);return i.ptr=r-1,n}(e,r.gctSize,i)):[]);a.header.gctList=n}else if(i.ptr+1<e.length&&33===e[i.ptr]&&255===e[i.ptr+1]&&!a.appExt){n=function(e,t){const i={appName:"",verification:"",blockIdx:1,repetitionTimes:0,startByte:0,endByte:0};i.startByte=t.ptr;let a=i.startByte;var r=e[a+=2];a++;for(let t=0;t<r-3;t++)i.appName+=String.fromCharCode(e[a+t]);a+=r-3;for(let t=0;t<3;t++)i.verification+=String.fromCharCode(e[a+t]);a+=3;var n=e[a];return i.endByte=a+n,i.blockIdx=e[a+1],i.repetitionTimes=e[a+2]+(e[a+3]<<8),t.ptr=i.endByte,i}(e,i);a.appExt=n}else if(i.ptr+1<e.length&&33===e[i.ptr]&&249===e[i.ptr+1])a.frames.push(x(e,i));else if(44===e[i.ptr]){let t=x(e,i);var s=a.frames[a.frames.length-1];s.endByte?a.frames.push(t):(t.startByte=s.startByte,t.disposalMethod=s.disposalMethod,t.userInputFlag=s.userInputFlag,t.transColorFlag=s.transColorFlag,t.delay=s.delay,t.transColorIdx=s.transColorIdx,a.frames[a.frames.length-1]=t)}else if(i.ptr+1<e.length&&33===e[i.ptr]&&1===e[i.ptr+1])a.frames.push(x(e,i));else if(59===e[i.ptr])break;i.ptr++}console.log("parse: ",window.performance.now()-t),t=window.performance.now();const o=yield Promise.all(a.frames.map(t=>I({action:"gifLzwDecode",param:[t.codeSize,t.imageData],transferable:[t.imageData.buffer]})));return console.log("duration: ",window.performance.now()-t),o.map((t,e)=>{a.frames[e].imageData=t}),a})}var I=a=>new Promise((t,e)=>{var i=Date.now()*Math.random();v.push({_sign:i,job:a,p:{resolve:t,reject:e}}),M()});function x(a,t){const r={startByte:t.ptr,endByte:0,width:0,height:0,left:0,top:0,disposalMethod:0,userInputFlag:!1,transColorFlag:!1,delay:0,transColorIdx:0,lctFlag:!1,interlace:!1,sortFlag:!1,lctSize:0,lctStartByte:0,lctEndByte:0,lctList:[],codeSize:0,imageData:new Uint8Array,imageStartByte:0,imageEndByte:0};if(33===a[t.ptr]&&249===a[t.ptr+1]&&(t.ptr+=2,n=a[t.ptr],n=t.ptr+n+1,t.ptr++,r.disposalMethod=(28&a[t.ptr])>>2,r.userInputFlag=Boolean((2&a[t.ptr])>>1),r.transColorFlag=Boolean(1&a[t.ptr]),r.delay=10*(a[++t.ptr]+(a[++t.ptr]<<8)),r.transColorIdx=a[++t.ptr],(0!==a[++t.ptr]||t.ptr>n)&&(t.ptr=n)),44===a[t.ptr]){if(r.left=a[++t.ptr]+(a[++t.ptr]<<8),r.top=a[++t.ptr]+(a[++t.ptr]<<8),r.width=a[++t.ptr]+(a[++t.ptr]<<8),r.height=a[++t.ptr]+(a[++t.ptr]<<8),r.lctFlag=Boolean(128&a[++t.ptr]),r.interlace=Boolean(64&a[t.ptr]),r.sortFlag=Boolean(32&a[t.ptr]),r.lctSize=Math.pow(2,1+(7&a[t.ptr])),r.lctFlag){r.lctStartByte=t.ptr+1,r.lctEndByte=t.ptr+3*r.lctSize;for(let t=r.lctStartByte;t<r.lctEndByte;t+=3)r.lctList.push([a[t],a[t+1],a[t+2]]);t.ptr=r.lctEndByte}t.ptr++,r.imageStartByte=t.ptr;var n=a[t.ptr++];const h=[];let e=0;for(;0!==a[t.ptr]&&void 0!==a[t.ptr];){var s=a[t.ptr++],o=a.slice(t.ptr,t.ptr+s);e+=o.length,h.push(o),t.ptr+=s}r.imageEndByte=t.ptr,r.endByte=t.ptr;let i=new Uint8Array(e);for(let t=h.length-1;0<=t;t--)i.set(h[t],e-=h[t].length);r.codeSize=n,r.imageData=i}return r}function D(i){var t=performance.now();let a=0,r=t;a=window.requestAnimationFrame(function t(e){1e3/60<=e-r&&(r=e-(e-r)%(1e3/60),i.map(t=>{t(e)})),a=window.requestAnimationFrame(t)})}function L(t,i){const a=t.frames[i];if(a.canvasImageData instanceof ImageData)return a.canvasImageData;var r=function t(i,e){if(e<=0)return;const a=i.frames[e-1];if(0===a.disposalMethod)return;if(2===a.disposalMethod){const r=i.header.gctFlag?[...i.header.gctList[i.header.bgIndex],255]:[...u];let t=a.canvasImageData;t=t||L(i,e-1);const n=new ImageData(t.width,t.height);n.data.set(t.data);for(let e=a.top;e<a.top+a.height;e++)for(let t=a.left;t<a.left+a.width;t++){const s=e*i.header.width+t<<2;n.data[s]=r[0],n.data[1+s]=r[1],n.data[2+s]=r[2],n.data[3+s]=r[3]}return n}if([1].includes(a.disposalMethod))return a.canvasImageData||L(i,e-1);if(3===a.disposalMethod)return t(i,e-1);return}(t,i),n=a.lctFlag?a.lctList:t.header.gctList,s=t.header.gctFlag?[...t.header.gctList[t.header.bgIndex],255]:[...u],o=t.header.width,i=t.header.height,h=N(a);const l=new Uint8ClampedArray(o*i*4);for(let t=0,e=o*i;t<e;t++){var d=t%o,c=t/o>>0,g=t<<2;d>=a.left&&d<a.left+a.width&&c>=a.top&&c<a.top+a.height?(d=d-a.left+(c-a.top)*a.width,a.transColorFlag&&h[d]===a.transColorIdx?r&&(l[g]=r.data[g],l[1+g]=r.data[1+g],l[2+g]=r.data[2+g],l[3+g]=r.data[3+g]):(c=n[h[d]],l[g]=c[0],l[1+g]=c[1],l[2+g]=c[2],l[3+g]=255)):r?(l[g]=r.data[g],l[1+g]=r.data[1+g],l[2+g]=r.data[2+g],l[3+g]=r.data[3+g]):(l[g]=s[0],l[1+g]=s[1],l[2+g]=s[2],l[3+g]=s[3])}t=new ImageData(l,o,i);return a.canvasImageData=t}function j(t,e){const i=t.frames[e];if(i.independentImageData instanceof ImageData)return i.independentImageData;var a=i.lctFlag?i.lctList:t.header.gctList,r=N(i);const n=new Uint8ClampedArray(i.width*i.height*4);for(let t=0;t<i.imageData.length;t++){var s,o=t<<2;i.transColorFlag&&r[t]===i.transColorIdx?(n[o]=0,n[1+o]=0,n[2+o]=0,n[3+o]=0):(s=a[r[t]],n[o]=s[0],n[1+o]=s[1],n[2+o]=s[2],n[3+o]=255)}const h=new ImageData(i.width,i.height);return h.data.set(n),i.independentImageData=h}function N(a){const r=new Uint8Array(a.imageData.length);if(a.interlace){let e=0,i=0;function t(){for(let t=0;t<a.width;t++)r[i]=a.imageData[e*a.width+t],i++}for(;e<a.height;)t(),e+=8;for(e=4;e<a.height;)t(),e+=8;for(e=2;e<a.height;)t(),e+=4;for(e=1;e<a.height;)t(),e+=2}else r.set(a.imageData);return r}class E extends class{constructor(t){this.keys=[],this.watch={},this.amzGif=t,this.cache={},this.init()}init(){this.dirtyChecking()}dirtyChecking(){const e=[];let i;Object.keys(this.watch).map(t=>{i=this.getValue(t),this.cache[t]!==i&&e.push({key:t,oldValue:this.cache[t],newValue:i})}),e.map(t=>s(this,void 0,void 0,function*(){d(this.watch[t.key])&&(yield this.watch[t.key](t.newValue,t.oldValue))}))}getValue(t){var e=t.split(".").filter(t=>t);let i=this.amzGif;for(let t=0;t<e.length&&void 0!==(i=null===i||void 0===i?void 0:i[e[t]]);t++);return i}}{constructor(t){super(t),this.playDiv=null,this.playImg=null,this.loadingDiv=null,this.loadingImg=null,this.loadingImgRoate=0,this.handlePlay=this.handlePlay.bind(this),this.dirtyChecking=this.dirtyChecking.bind(this),this.init(),this.setWatch()}init(){const t=this.amzGif._canvas.parentElement;if(t){var e=t.getBoundingClientRect();const i=this.genMask(e.width,e.height),a=(i.style.zIndex="1",i.style.display="none",i.style.cursor="pointer",i.addEventListener("click",this.handlePlay.bind(this)),this.playDiv=i,document.createElement("img")),r=(a.src="data:image/svg+xml;base64,PHN2ZyB0PSIxNjYyNzg5NjY0NjUyIiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIzNjciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNMTI4IDEzOC42NjY2NjdjMC00Ny4yMzIgMzMuMzIyNjY3LTY2LjY2NjY2NyA3NC4xNzYtNDMuNTYyNjY3bDY2My4xNDY2NjcgMzc0Ljk1NDY2N2M0MC45NiAyMy4xNjggNDAuODUzMzMzIDYwLjggMCA4My44ODI2NjZMMjAyLjE3NiA5MjguODk2QzE2MS4yMTYgOTUyLjA2NCAxMjggOTMyLjU2NTMzMyAxMjggODg1LjMzMzMzM3YtNzQ2LjY2NjY2NnoiIGZpbGw9IiMzRDNEM0QiIHAtaWQ9IjIzNjgiPjwvcGF0aD48L3N2Zz4=",a.style.width="60px",a.style.height="60px",a.style.opacity="0.6",this.playImg=a,i.appendChild(a),t.appendChild(i),this.genMask(e.width,e.height)),n=((this.loadingDiv=r).style.zIndex="2",r.style.display="none",document.createElement("img"));(this.loadingImg=n).src="data:image/svg+xml;base64,PHN2ZyB0PSIxNjYyNzg5NzI0Njc4IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjM0NDEiIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48cGF0aCBkPSJNNTEyLjUxMSAyMS40ODNjLTI3MS4xNjMgMC00OTEuMDI4IDIxOS44Ni00OTEuMDI4IDQ5MS4wMjggMCAyNzEuMTczIDIxOS44NTYgNDkxLjAzIDQ5MS4wMjggNDkxLjAzIDI2LjU1NCAwIDQ4LjA4LTIxLjUyNyA0OC4wOC00OC4wOCAwLTI2LjU1NC0yMS41MjYtNDguMDgtNDguMDgtNDguMDgtMjE4LjA2NSAwLTM5NC44NjktMTc2LjgwNC0zOTQuODY5LTM5NC44NyAwLTIxOC4wNiAxNzYuODEzLTM5NC44NjkgMzk0Ljg3LTM5NC44NjkgMjE4LjA2NSAwIDM5NC44NjkgMTc2LjgwNCAzOTQuODY5IDM5NC44NyAwIDI2LjU1MyAyMS41MjYgNDguMDggNDguMDggNDguMDggMjYuNTUzIDAgNDguMDgtMjEuNTI3IDQ4LjA4LTQ4LjA4IDAtMjcxLjE3My0yMTkuODU3LTQ5MS4wMy00OTEuMDMtNDkxLjAzeiIgcC1pZD0iMzQ0MiI+PC9wYXRoPjwvc3ZnPg==",n.style.width="60px",n.style.height="60px",n.style.opacity="0.6",r.appendChild(n),t.appendChild(r),this.amzGif._rAFCallbackQueue.push(this.dirtyChecking.bind(this))}else this.amzGif._errCall(c.skinError,"onError")}genMask(t,e){const i=document.createElement("div");return i.style.backgroundColor="rgba(0, 0, 0, 0.3)",i.style.width=t+"px",i.style.height=e+"px",i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.display="flex",i.style.justifyContent="center",i.style.alignItems="center",i}setWatch(){this.watch.isPlaying=t=>{this.playDiv&&(this.playDiv.style.display=t||this.amzGif.isLoading?"none":"flex")},this.watch.isLoading=t=>{this.loadingDiv&&(this.loadingDiv.style.display=t?"flex":"none",t&&this.loadingImg&&(this.loadingImg.style.transform=`rotate(${this.loadingImgRoate+=1}deg)`))}}handlePlay(){this.amzGif.isPlaying||this.amzGif.play()}}function F(n){return s(this,void 0,void 0,function*(){let t={buf:k(new Uint8Array(0)),ptr:0};var e,i;if(i=t,e=n.header,i.buf[0]=e.type.charCodeAt(0),i.buf[1]=e.type.charCodeAt(1),i.buf[2]=e.type.charCodeAt(2),i.buf[3]=e.version.charCodeAt(0),i.buf[4]=e.version.charCodeAt(1),i.buf[5]=e.version.charCodeAt(2),i.ptr=6,e=t,i=n.header,e.buf[6]=255&i.width,e.buf[7]=i.width>>8,e.buf[8]=255&i.height,e.buf[9]=i.height>>8,e.buf[10]=f(e.buf[10],7,1,Number(i.gctFlag)),e.buf[10]=f(e.buf[10],4,3,i.cr-1),e.buf[10]=f(e.buf[10],3,1,Number(i.sortFlag)),e.buf[10]=f(e.buf[10],0,3,g(i.gctSize)-1),e.buf[11]=i.bgIndex,e.buf[12]=i.pixelAspect,e.ptr=13,n.header.gctFlag&&z(t,n.header.gctList),n.appExt){var a=t,r=n.appExt;a.ptr+18>=a.buf.length&&(a.buf=k(a.buf)),a.buf[a.ptr++]=33,a.buf[a.ptr++]=255,a.buf[a.ptr++]=r.appName.length+r.verification.length;for(let t=0,e=r.appName.length;t<e;t++)a.buf[a.ptr++]=r.appName.charCodeAt(t);for(let t=0,e=r.verification.length;t<e;t++)a.buf[a.ptr++]=r.verification.charCodeAt(t);a.buf[a.ptr++]=3,a.buf[a.ptr++]=r.blockIdx,a.buf[a.ptr++]=255&r.repetitionTimes,a.buf[a.ptr++]=r.repetitionTimes>>8,a.buf[a.ptr++]=0}return yield function(d,c,i){return s(this,void 0,void 0,function*(){const a=[];var t=window.performance.now(),r=yield Promise.all(c.map((t,e)=>(a[e]=t.lctFlag?g(t.lctSize):g(i),I({action:"gifLzwEncode",param:[a[e],t.imageData]}))));console.log("encode frames buffer: ",window.performance.now()-t);for(let t=0,e=c.length;t<e;t++){var n=c[t],s=(o=s=void 0,d),o=n,o=(s.ptr+8>=s.buf.length&&(s.buf=k(s.buf)),s.buf[s.ptr++]=33,s.buf[s.ptr++]=249,s.buf[s.ptr++]=4,s.buf[s.ptr]=f(s.buf[s.ptr],2,3,o.disposalMethod),s.buf[s.ptr]=f(s.buf[s.ptr],1,1,Number(o.userInputFlag)),s.buf[s.ptr]=f(s.buf[s.ptr],0,1,Number(o.transColorFlag)),s.ptr++,s.buf[s.ptr++]=o.delay/10&255,s.buf[s.ptr++]=o.delay/10>>8,s.buf[s.ptr++]=o.transColorIdx,s.buf[s.ptr++]=0,s=o=void 0,d),s=n;o.ptr+10>=o.buf.length&&(o.buf=k(o.buf)),o.buf[o.ptr++]=44,o.buf[o.ptr++]=255&s.left,o.buf[o.ptr++]=s.left>>8,o.buf[o.ptr++]=255&s.top,o.buf[o.ptr++]=s.top>>8,o.buf[o.ptr++]=255&s.width,o.buf[o.ptr++]=s.width>>8,o.buf[o.ptr++]=255&s.height,o.buf[o.ptr++]=s.height>>8,o.buf[o.ptr]=f(o.buf[o.ptr],7,1,Number(s.lctFlag)),o.buf[o.ptr]=f(o.buf[o.ptr],6,1,Number(s.interlace)),o.buf[o.ptr]=f(o.buf[o.ptr],2,1,Number(s.sortFlag)),o.buf[o.ptr]=f(o.buf[o.ptr],0,3,g(s.lctSize)-1),o.ptr++,n.lctFlag&&z(d,n.lctList);for(var h=r[t],l=h.length+Math.ceil(h.length/255);d.ptr+1+l>=d.buf.length;)d.buf=k(d.buf);d.buf[d.ptr++]=a[t];let i=d.ptr;for(let t=0,e=h.length;t<e;t++)i===d.ptr&&d.ptr++,d.buf[d.ptr]=h[t],d.ptr-i!=255&&t+1!==e||(d.buf[i]=d.ptr-i,i=d.ptr+1),d.ptr++;d.buf[d.ptr++]=0}})}(t,n.frames,n.header.gctSize),t.ptr>=t.buf.length&&(t.buf=k(t.buf)),t.buf[t.ptr]=59,t.ptr++,t.buf.slice(0,t.ptr)})}function z(i,a){for(let t=0,e=a.length;t<e;t++)i.ptr+3>=i.buf.length&&(i.buf=k(i.buf)),i.buf[i.ptr++]=a[t][0],i.buf[i.ptr++]=a[t][1],i.buf[i.ptr++]=a[t][2]}function k(t){var e=1048576;if(e=e||256,t instanceof Uint8Array){const i=new Uint8Array(t.length+e);return i.set(t),i}}var P={decode(t,i){return s(this,void 0,void 0,function*(){return C(t,(t,e)=>i(t))})},encode(t){return s(this,void 0,void 0,function*(){return F(t)})},getFrameImageData:j,getFramesImageData(i){return i.frames.map((t,e)=>j(i,e))},getCompositeFrameImageData:L,getCompositeFramesImageData(i){return i.frames.map((t,e)=>L(i,e))}};class S{constructor(t){this.speedList=i,this._imgEl=null,this._canvas=null,this._ctx=null,this._offscreenCanvas=null,this._offscreenCtx=null,this._gifBuffer=null,this.gifData=null,this._currFrame=-1,this._nextUpdateTime=performance.now(),this._rAFCallbackQueue=[],this.isLoading=!1,this.isPlaying=!1,this.isRendering=!1,this._config=Object.assign(Object.assign({},e),t),i.includes(this._config.speed)||(this._config.speed=1),this._update=this._update.bind(this),this._renderFrame=this._renderFrame.bind(this),this._togglePlay=this._togglePlay.bind(this),this._init()}_init(){if(this._config.el){if(this._config.el instanceof HTMLImageElement&&(this._imgEl=this._config.el),"string"==typeof this._config.el){var t=document.querySelector(this._config.el);if(!t)return void this._errCall(c.noImg+this._config.el,"onError");if(!(t instanceof HTMLImageElement))return void this._errCall(c.notImg(this._config.el),"onError");this._imgEl=t}setTimeout(()=>{var t;this._initCanvas(),this._initContainer(),(t=this)._config.interactive&&"basic"===t._config.skin&&new E(t),!0===this._config.auto&&this.play(),this._rAFCallbackQueue.push(this._update),D(this._rAFCallbackQueue)})}else this._errCall(c.noConfigEl,"onError")}_initCanvas(){var t;const e=this._imgEl;var i=e.getBoundingClientRect();console.log(i),this._config.width="number"==typeof this._config.width?this._config.width:null!=(t=null==i?void 0:i.width)?t:0,this._config.height="number"==typeof this._config.height?this._config.height:null!=(t=null==i?void 0:i.height)?t:0,this._canvas=document.createElement("canvas"),this._canvas.style.cursor="pointer",this._canvas.addEventListener("click",this._togglePlay),this._canvas.width=this._config.width,this._canvas.height=this._config.height,this._canvas.style.width=this._config.width+"px",this._canvas.style.height=this._config.height+"px",this._ctx=this._canvas.getContext("2d"),this._ctx.globalCompositeOperation="copy",null!=(t=this._ctx)&&t.drawImage(e,0,0,null!=(t=null==i?void 0:i.width)?t:this._config.width,null!=(t=null==i?void 0:i.height)?t:this._config.height,0,0,null!=(t=this._config.width)?t:null==i?void 0:i.width,null!=(t=this._config.height)?t:null==i?void 0:i.height)}_initContainer(){var t,e=this._imgEl;const i=document.createElement("div");e.id&&(i.id=e.id),i.style.width=this._config.width+"px",i.style.height=this._config.height+"px",i.style.position="relative",i.style.display="inline-block",this._canvas&&(i.appendChild(this._canvas),null!=(t=e.parentElement)&&t.replaceChild(i,e))}play(){var e;return s(this,void 0,void 0,function*(){if(null===this._gifBuffer){if(!this._config.src&&"function"!=typeof this._config.httpRequest)return this._errCall(c.noGifUrl,"onError");yield this._getGif().catch(t=>this._errCall(t.message,"onLoadError"))}if(null!==this._gifBuffer){if(null===this.gifData){var t=yield C(this._gifBuffer,this._errCall);if(!t||!t.header.isGif)return;this.gifData=t,this._offscreenCanvas=document.createElement("canvas"),this._offscreenCanvas.width=null==(e=this.gifData)?void 0:e.header.width,this._offscreenCanvas.height=null==(e=this.gifData)?void 0:e.header.height,this._offscreenCtx=this._offscreenCanvas.getContext("2d")}if(d(this._config.onBeforePlay))if(!(yield this._config.onBeforePlay()))return;this.isPlaying=!0,this._nextUpdateTime=Math.max(this._nextUpdateTime,performance.now()),this._checkEnd()&&(this._currFrame=-1),d(this._config.onPlay)&&this._config.onPlay()}})}pause(){return s(this,void 0,void 0,function*(){if(d(this._config.onBeforePause)&&!(yield this._config.onBeforePause()))return;this.isPlaying=!1,d(this._config.onPause)&&this._config.onPause()})}nextFrame(){return this.gifData&&this._ctx&&this._offscreenCtx?this.isRendering?c.isRendering:(this._currFrame=(this._currFrame+1)%this.gifData.frames.length,this._renderFrame(),void(this._nextUpdateTime=performance.now()+this.gifData.frames[this._currFrame].delay/this._config.speed)):this._errCall(c.notReady,"onError")}prevFrame(){return this.gifData&&this._ctx&&this._offscreenCtx?this.isRendering?c.isRendering:(this._currFrame--,this._currFrame<0&&(this._currFrame=this.gifData.frames.length-1),this._renderFrame(),void(this._nextUpdateTime=performance.now()+this.gifData.frames[this._currFrame].delay/this._config.speed)):this._errCall(c.notReady,"onError")}jump(t){return this.gifData?"number"!=typeof t?this._errCall(c.wrongParam,"onError"):this.isRendering?c.isRendering:((t<0||t>this.gifData.frames.length-1)&&(t=0),this._currFrame=t,void this._renderFrame()):this._errCall(c.notReady,"onError")}setSpeed(t){return!!this.speedList.includes(t)&&(this._config.speed=t,!0)}_togglePlay(){!1!==this._config.interactive&&(this.isPlaying?this.pause():this.play())}_update(t){if(this.isPlaying&&!this.isRendering&&this.gifData&&this._ctx&&this._offscreenCtx&&!document.hidden&&!(this._nextUpdateTime>t))if(this._currFrame++,this._checkEnd())this.isPlaying=!1,d(this._config.onEnd)&&this._config.onEnd();else for(this._renderFrame();this._nextUpdateTime<=t;)this._nextUpdateTime+=Math.max(this.gifData.frames[this._currFrame].delay/this._config.speed,1),this._nextUpdateTime<=t&&(this._currFrame++,this._checkEnd()&&(this.isPlaying=!1,d(this._config.onEnd)&&this._config.onEnd(),this._currFrame=this.gifData.frames.length-1,this._renderFrame()))}_renderFrame(){var t=this.gifData,i=this._ctx,a=this._offscreenCtx;this.isRendering=!0;{var r=this._currFrame,n=t=>d(this._config.filter)?this._config.filter(t):t;let e=L(t,r);if(d(n)){let t=new ImageData(e.width,e.height);t.data.set(e.data),t=n(t),e=t}a.putImageData(e,0,0),i.drawImage(a.canvas,0,0,e.width,e.height,0,0,i.canvas.width,i.canvas.height),e}this.isRendering=!1}_checkEnd(){return this._currFrame>this.gifData.frames.length-1&&(!1===this._config.loop||(this._currFrame=0,!1))}_getGif(){return s(this,void 0,void 0,function*(){if(this.isLoading=!0,d(this._config.httpRequest))try{const t=yield this._config.httpRequest(this._config.src);this._gifBuffer=yield t.arrayBuffer()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}else try{const e=yield fetch(this._config.src);this._gifBuffer=yield e.arrayBuffer(),d(this._config.onLoad)&&this._config.onLoad()}catch(t){this._errCall(null==t?void 0:t.message,"onLoadError")}this.isLoading=!1})}_errCall(t,e){var i;if(d(this._config[e]))null!=(e=(i=this._config)[e])&&e.call(i,t);else{if(!d(this._config.onError))throw new Error(t);null!=(i=(e=this._config).onError)&&i.call(e,t)}}}return S.filter={grayscale:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=.3*i.data[t]+.59*i.data[t+1]+.11*i.data[t+2]>>0;i.data[t]=i.data[t+1]=i.data[t+2]=a}return i},blackAndWhite:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=(i.data[t]+i.data[t+1]+i.data[t+2])/3;i.data[t]=i.data[t+1]=i.data[t+2]=100<=a?255:0}return i},reverse:function(i){for(let t=0,e=i.data.length;t<e;t+=4)i.data[t]=255-i.data[t],i.data[t+1]=255-i.data[t+1],i.data[t+2]=255-i.data[t+2];return i},decolorizing:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=(Math.min(i.data[t],i.data[t+1],i.data[t+2])+Math.max(i.data[t],i.data[t+1],i.data[t+2]))/2>>0;i.data[t]=i.data[t+1]=i.data[t+2]=a}return i},monochromeRed:function(i){for(let t=0,e=i.data.length;t<e;t+=4)i.data[t+1]=i.data[t+2]=0;return i},monochromeGreen:function(i){for(let t=0,e=i.data.length;t<e;t+=4)i.data[t]=i.data[t+2]=0;return i},monochromeBlue:function(i){for(let t=0,e=i.data.length;t<e;t+=4)i.data[t]=i.data[t+1]=0;return i},nostalgic:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=i.data[t],r=i.data[t+1],n=i.data[t+2],s=.349*a+.686*r+.168*n,o=.272*a+.534*r+.131*n;i.data[t]=Math.min(255,Math.max(0,.393*a+.769*r+.189*n)),i.data[t+1]=Math.min(255,Math.max(0,s)),i.data[t+2]=Math.min(255,Math.max(0,o))}return i},cast:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=i.data[t],r=i.data[t+1],n=i.data[t+2],s=128*r/(a+n+1),o=128*n/(r+a+1);i.data[t]=Math.min(255,Math.max(0,128*a/(r+n+1))),i.data[t+1]=Math.min(255,Math.max(0,s)),i.data[t+2]=Math.min(255,Math.max(0,o))}return i},frozen:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=i.data[t],r=i.data[t+1],n=i.data[t+2],s=3*(r-a-n)/2,o=3*(n-r-a)/2;i.data[t]=Math.min(255,Math.max(0,3*(a-r-n)/2)),i.data[t+1]=Math.min(255,Math.max(0,s)),i.data[t+2]=Math.min(255,Math.max(0,o))}return i},comic:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=i.data[t],r=i.data[t+1],n=i.data[t+2];i.data[t]=Math.abs(r-n+r+a)*a/256,i.data[t+1]=Math.abs(n-r+n+a)*a/256,i.data[t+2]=Math.abs(n-r+n+a)*r/256}return i},brown:function(i){for(let t=0,e=i.data.length;t<e;t+=4){var a=i.data[t],r=i.data[t+1],n=i.data[t+2],s=.349*a+.686*r+.168*n,o=.272*a+.534*r+.131*n;i.data[t]=Math.min(255,Math.max(0,.393*a+.769*r+.189*n)),i.data[t+1]=Math.min(255,Math.max(0,s)),i.data[t+2]=Math.min(255,Math.max(0,o))}return i},boxBlur:function(i,a=5){const r=new ImageData(i.width,i.height);var n,s;r.data.set(i.data),a=a%2?a:a+1;let o=new Uint8ClampedArray(a*a),h=0,l=0;for(let e=0,t=i.data.length;e<t;e+=4){n=e/4%i.width,s=e/4/i.width>>0;for(let t=0;t<3;t++){o=function(i,a,r,n,s,o,h){let l=!1,d=!1;var c,g,f=[s/2>>0,o/2>>0];let u=0;for(let e=0;e<s;e++)for(let t=0;t<o;t++)l=!1,d=!1,0<(c=f[0]-e)?a<c&&(l=!0):a-c>=i.width&&(l=!0),g=f[1]-t,t<f[1]?r<g&&(d=!0):r-g>=i.height&&(d=!0),l&&d?u=0<c&&0<g?0:c<0&&g<0?4*(i.width*i.height-1):0<c?i.width*(i.height-1)*4:4*(i.width-1):l?u=c<0?(r-g)*i.width*4:4*((r-g)*i.width-1):d&&(u=g<0?4*(a-c):4*((i.height-1)*i.width+a-c)),u=4*((r-g)*i.width+(a-c)),n[e+s*t]=i.data[u+h];return n}(i,n,s,o,a,a,t);for(let t=h=0,e=o.length;t<e;t++)h+=o[t];(l=h/o.length>>0)<0?l=0:255<l&&(l=255),r.data[e+t]=l}}return r}},S.gifKit=P,S});
